<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ame Scan Facial - CRM para Est√©tica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
        }
        .nav-link.active {
            background-color: #e3f2e9;
            color: #1e40af;
            font-weight: 600;
        }
        .image-compare-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .image-compare-after {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            object-fit: cover;
            clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);
        }
        .image-compare-slider {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background-color: white;
            cursor: ew-resize;
            z-index: 10;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .diary-item.selected {
            background-color: #d1fae5;
            border: 2px solid #10b981;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 80%;
            border: 4px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .shelf-product-card {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .shelf-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .client-card {
             transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .routine-section-title {
            font-weight: 600;
            color: #1e3a8a;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid #93c5fd;
        }
        /* Agenda Styles */
        .agenda-day-header.today {
            background-color: #3b82f6;
            color: white;
        }
        .appointment-card {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .appointment-card:hover {
            background-color: #dbeafe; /* lighter blue */
        }
        .ficha-label {
            font-size: 0.875rem; /* 14px */
            font-weight: 700; /* bold */
            color: rgb(107 114 128);
        }
        .ficha-value {
            margin-top: 0.25rem;
            color: rgb(31 41 55);
            white-space: pre-wrap;
        }
        .anamnesis-section-title {
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            color: rgb(30 64 175);
            border-bottom-width: 2px;
            border-color: rgb(191 219 254);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .discount-toggle-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            background-color: #f9fafb; /* gray-50 */
            color: #4b5563; /* gray-600 */
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: all 0.2s ease-in-out;
        }
        .discount-toggle-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6; /* blue-500 */
        }
        .discount-toggle-btn:first-of-type {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }
        .discount-toggle-btn:last-of-type {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            border-left-width: 0px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="flex h-screen">
        <aside id="main-nav" class="w-64 bg-white border-r border-gray-200 p-4 flex-col flex">
            <h1 class="text-2xl font-bold text-blue-800 mb-4">Ame Scan Facial</h1>

            <nav id="app-nav" class="flex flex-col space-y-2 mb-6">
                <a href="#dashboard" class="app-nav-link nav-link active p-3 rounded-lg flex items-center space-x-3">
                    <span>üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="#clients" class="app-nav-link nav-link p-3 rounded-lg flex items-center space-x-3">
                    <span>üë•</span>
                    <span>Clientes</span>
                </a>
                <a href="#agenda" class="app-nav-link nav-link p-3 rounded-lg flex items-center space-x-3">
                    <span>üìÖ</span>
                    <span>Agenda</span>
                </a>
                <div id="admin-menu-toggle" class="app-nav-link nav-link p-3 rounded-lg flex items-center space-x-3 cursor-pointer">
                    <span‚öôÔ∏è</span>
                    <span>Administraci√≥n</span>
                </div>
                <nav id="admin-submenu" class="pl-6 flex-col space-y-1 hidden">
                    <a href="#caja" class="app-nav-link nav-link p-2 rounded-lg flex items-center space-x-2 text-sm">
                        <span>üí∞</span>
                        <span>Caja</span>
                    </a>
                    <a href="#servicios" class="app-nav-link nav-link p-2 rounded-lg flex items-center space-x-2 text-sm">
                         <span>üõ†Ô∏è</span>
                         <span>Servicios</span>
                    </a>
                    <a href="#productos" class="app-nav-link nav-link p-2 rounded-lg flex items-center space-x-2 text-sm">
                        <span>üì¶</span>
                        <span>Productos</span>
                   </a>
                    <a href="#balance-mensual" class="app-nav-link nav-link p-2 rounded-lg flex items-center space-x-2 text-sm">
                        <span>üìä</span>
                        <span>Balance Mensual</span>
                    </a>
                </nav>
            </nav>

            <div id="client-context-nav" class="hidden">
                 <hr class="mb-4">
                 <div id="selected-client-display" class="mb-4">
                       <p class="text-sm text-gray-500">Perfil de:</p>
                       <p class="font-semibold text-blue-700" id="selected-client-name"></p>
                 </div>
                <nav id="client-nav" class="flex flex-col space-y-2">
                    <a href="#scanner" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                        <span>üì∑</span>
                        <span>Esc√°ner Facial</span>
                    </a>
                     <a href="#anamnesis" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                          <span>üìã</span>
                          <span>Ficha Personal</span>
                     </a>
                    <a href="#diary" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                        <span>üìî</span>
                        <span>Diario Hol√≠stico</span>
                    </a>
                    <a href="#shelf" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                        <span>üß¥</span>
                        <span>Mi Estanter√≠a</span>
                    </a>
                    <a href="#routines" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                        <span>üåû</span>
                        <span>Mis Rutinas</span>
                    </a>
                    <a href="#progress" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                        <span>üìà</span>
                        <span>Mi Progreso</span>
                    </a>
                     <a href="#treatments" class="nav-link p-3 rounded-lg flex items-center space-x-3">
                          <span>üíÜ‚Äç‚ôÄÔ∏è</span>
                          <span>Tratamientos</span>
                     </a>
                </nav>
            </div>
            
            <div id="auth-status" class="mt-auto text-xs text-gray-400">Conectando...</div>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
            <section id="dashboard" class="space-y-6">
                 <div>
                       <h2 class="text-3xl font-bold text-gray-900">Dashboard</h2>
                       <p class="mt-2 text-gray-600">Resumen de tu actividad de hoy.</p>
                 </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4">Accesos R√°pidos</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button id="dashboard-add-appointment-btn" class="bg-blue-600 text-white font-semibold py-4 px-4 rounded-lg hover:bg-blue-700 transition-colors text-center">A√±adir Turno</button>
                        <button id="dashboard-add-client-btn" class="bg-green-600 text-white font-semibold py-4 px-4 rounded-lg hover:bg-green-700 transition-colors text-center">A√±adir Cliente</button>
                        <button id="dashboard-go-to-caja-btn" class="bg-indigo-600 text-white font-semibold py-4 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-center">Ir a Caja</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div class="bg-green-100 p-4 rounded-lg flex flex-col justify-center">
                        <h4 class="text-sm font-semibold text-green-800">INGRESOS DE HOY</h4>
                        <p id="dashboard-ingresos" class="text-2xl font-bold text-green-700 break-words">$0.00</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg flex flex-col justify-center">
                        <h4 class="text-sm font-semibold text-red-800">GASTOS DE HOY</h4>
                        <p id="dashboard-gastos" class="text-2xl font-bold text-red-700 break-words">$0.00</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg flex flex-col justify-center">
                        <h4 class="text-sm font-semibold text-blue-800">BALANCE DE HOY</h4>
                        <p id="dashboard-balance" class="text-2xl font-bold text-blue-700 break-words">$0.00</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4">Turnos de Hoy</h3>
                    <div id="dashboard-appointments-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Today's appointments will be dynamically inserted here -->
                    </div>
                </div>

            </section>

            <section id="clients" class="hidden space-y-6">
                 <div class="flex justify-between items-center mb-4">
                       <div>
                             <h2 class="text-3xl font-bold text-gray-900">Mis Clientes</h2>
                             <p class="mt-2 text-gray-600">Selecciona un cliente para ver su perfil o a√±ade uno nuevo.</p>
                       </div>
                    <button id="add-client-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">A√±adir Cliente</button>
                </div>
                <div class="relative">
                    <input type="text" id="client-search-input" placeholder="Buscar cliente..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div id="client-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Client cards will be dynamically inserted here -->
                </div>
            </section>

            <section id="agenda" class="hidden space-y-6">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                     <div>
                           <h2 class="text-3xl font-bold text-gray-900">Agenda de Turnos</h2>
                           <p class="mt-2 text-gray-600">Gestiona tus citas de la semana.</p>
                     </div>
                    <div id="agenda-toolbar" class="flex items-center space-x-2 bg-white p-2 rounded-lg border">
                        <button id="prev-week-btn" class="p-2 rounded hover:bg-gray-100">&lt;</button>
                        <h3 id="agenda-date-range" class="text-lg font-semibold text-center w-48"></h3>
                        <button id="next-week-btn" class="p-2 rounded hover:bg-gray-100">&gt;</button>
                        <button id="today-btn" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600">Hoy</button>
                    </div>
                </div>
                <div id="agenda-view" class="grid grid-cols-7 gap-1 md:gap-2 h-[calc(100vh-250px)] overflow-y-auto bg-white p-2 rounded-lg shadow-sm border">
                    <!-- Agenda day columns will be dynamically generated here -->
                </div>
            </section>

            <section id="caja" class="hidden space-y-6">
                <div>
                     <h2 class="text-3xl font-bold text-gray-900">Gesti√≥n de Caja</h2>
                     <p class="mt-2 text-gray-600">Controla los ingresos y gastos de tu negocio.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-green-800">TOTAL INGRESOS</h4>
                        <p id="total-ingresos" class="text-xl lg:text-2xl font-bold text-green-700 break-words">$0.00</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-red-800">TOTAL GASTOS</h4>
                        <p id="total-gastos" class="text-xl lg:text-2xl font-bold text-red-700 break-words">$0.00</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-blue-800">BALANCE</h4>
                        <p id="balance" class="text-xl lg:text-2xl font-bold text-blue-700 break-words">$0.00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Ingresos</h3>
                            <button id="add-ingreso-btn" class="bg-green-500 text-white text-sm font-semibold py-1 px-3 rounded-lg hover:bg-green-600">+</button>
                        </div>
                        <div id="ingresos-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Gastos</h3>
                            <button id="add-gasto-btn" class="bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded-lg hover:bg-red-600">+</button>
                        </div>
                        <div id="gastos-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </section>
            
            <section id="servicios" class="hidden space-y-6">
                 <div class="flex justify-between items-center">
                       <div>
                             <h2 class="text-3xl font-bold text-gray-900">Administraci√≥n de Servicios</h2>
                             <p class="mt-2 text-gray-600">Gestiona los servicios de tu centro de est√©tica.</p>
                       </div>
                    <button id="add-service-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">A√±adir Servicio</button>
                </div>
                 <div id="services-list-container" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                       <div id="services-list" class="space-y-4">
                             <!-- Services will be dynamically inserted here -->
                       </div>
                 </div>
            </section>

            <section id="productos" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                      <div>
                            <h2 class="text-3xl font-bold text-gray-900">Administraci√≥n de Productos</h2>
                            <p class="mt-2 text-gray-600">Gestiona el inventario de productos de tu centro.</p>
                      </div>
                   <button id="add-admin-product-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">A√±adir Producto</button>
               </div>
                <div id="admin-products-list-container" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                      <div id="admin-products-list" class="space-y-4">
                            <!-- Admin products will be dynamically inserted here -->
                      </div>
                </div>
           </section>

            <section id="balance-mensual" class="hidden space-y-6">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Balance Mensual</h2>
                        <p class="mt-2 text-gray-600">Analiza el rendimiento financiero de tu negocio mes a mes.</p>
                    </div>
                    <div id="balance-toolbar" class="flex items-center space-x-2 bg-white p-2 rounded-lg border">
                        <button id="prev-month-btn" class="p-2 rounded hover:bg-gray-100">&lt;</button>
                        <h3 id="balance-month-display" class="text-lg font-semibold text-center w-40 capitalize"></h3>
                        <button id="next-month-btn" class="p-2 rounded hover:bg-gray-100">&gt;</button>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                       <div class="bg-green-100 p-4 rounded-lg">
                             <h4 class="text-sm font-semibold text-green-800">INGRESOS DEL MES</h4>
                             <p id="monthly-ingresos" class="text-xl lg:text-2xl font-bold text-green-700 break-words">$0.00</p>
                       </div>
                       <div class="bg-red-100 p-4 rounded-lg">
                             <h4 class="text-sm font-semibold text-red-800">EGRESOS DEL MES</h4>
                             <p id="monthly-gastos" class="text-xl lg:text-2xl font-bold text-red-700 break-words">$0.00</p>
                       </div>
                       <div class="bg-blue-100 p-4 rounded-lg">
                             <h4 class="text-sm font-semibold text-blue-800">SALDO DEL MES</h4>
                             <p id="monthly-balance" class="text-xl lg:text-2xl font-bold text-blue-700 break-words">$0.00</p>
                       </div>
                 </div>
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                       <h3 class="text-xl font-semibold mb-4 text-center">Actividad Diaria del Mes</h3>
                       <div class="chart-container h-96 w-full max-w-none">
                             <canvas id="monthlyBalanceChart"></canvas>
                       </div>
                 </div>
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                       <h3 class="text-xl font-semibold mb-4">Detalle de Movimientos</h3>
                       <div id="monthly-transactions-list" class="space-y-3 max-h-96 overflow-y-auto">
                             <!-- Transaction list will be dynamically inserted here -->
                       </div>
                 </div>
            </section>
            
            <div id="client-profile-container" class="hidden">
                <section id="scanner" class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-900">Tu piel, tu necesidad</h2>
                        <p class="mt-2 text-gray-600">Obt√©n un an√°lisis detallado y transparente de tu piel en segundos.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-xl font-semibold mb-4">Tu An√°lisis</h3>
                            <div class="relative w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center">
                                <img id="user-photo" src="https://placehold.co/400x400/EBF5FF/3B82F6?text=Tu+Foto+Aqu%C3%AD" alt="Placeholder para foto de usuario" class="rounded-lg object-cover w-full h-full">
                                <div id="heatmap-overlay" class="absolute top-0 left-0 w-full h-full opacity-0 mix-blend-multiply rounded-lg transition-opacity duration-300" style="background: radial-gradient(circle at 30% 45%, rgba(255, 0, 0, 0.45), transparent 25%), radial-gradient(circle at 70% 45%, rgba(255, 0, 0, 0.45), transparent 25%), radial-gradient(circle at 60% 35%, rgba(139, 69, 19, 0.6), transparent 8%), radial-gradient(circle at 45% 60%, rgba(139, 69, 19, 0.6), transparent 6%);"></div>
                            </div>
                            <div id="scanner-actions" class="mt-4 space-y-2">
                                <div id="initial-actions">
                                    <button id="activate-camera-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Activar C√°mara</button>
                                    <button id="upload-photo-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors mt-2">Subir una foto</button>
                                    <input type="file" id="photo-upload-input" class="hidden" accept="image/*">
                                </div>
                                <div id="after-photo-actions" class="hidden">
                                    <button id="analyze-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Iniciar An√°lisis Facial</button>
                                    <button id="reset-photo-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors mt-2">Elegir otra foto</button>
                                </div>
                                <p id="api-error-msg" class="text-red-500 text-sm text-center hidden mt-2"></p>
                            </div>
                             <div class="mt-4 flex items-center space-x-2">
                                   <input type="checkbox" id="heatmap-toggle" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500" disabled>
                                   <label for="heatmap-toggle" class="text-sm text-gray-700">Mostrar mapa de calor de √°reas de inter√©s</label>
                             </div>
                        </div>

                        <div id="results-container" class="space-y-6 hidden">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
                                <div class="grid grid-cols-2 gap-4 items-center divide-x divide-gray-200">
                                    <div>
                                        <h3 class="text-lg font-semibold mb-1 text-gray-600">Puntuaci√≥n Global</h3>
                                        <p class="text-6xl font-bold text-blue-600" id="global-score">82</p>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold mb-1 text-gray-600">Edad Aparente</h3>
                                        <p class="text-6xl font-bold text-gray-700" id="skin-age">27</p>
                                        <p class="text-sm text-gray-500 -mt-2">a√±os</p>
                                    </div>
                                </div>
                                <p class="text-gray-500 mt-4" id="global-score-feedback">¬°Un resultado excelente! Sigue as√≠.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-semibold mb-4 text-center">Desglose de M√©tricas</h3>
                                <div class="chart-container">
                                    <canvas id="skinMetricsChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-xl font-semibold mb-4">Detalles y Consejos Personalizados</h3>
                                <div id="metrics-details" class="space-y-4"></div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                <button id="email-results-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                    </svg>
                                    <span>Enviar Resultados por Email</span>
                                </button>
                            </div>
                        </div>
                        <div id="loader-container" class="flex items-center justify-center h-full hidden">
                            <div class="text-center">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4 text-gray-600">Analizando tu piel con IA...</p>
                                <p class="text-sm text-gray-400">Esto puede tardar unos segundos.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="anamnesis" class="hidden space-y-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">Ficha Personal</h2>
                        <p class="mt-2 text-gray-600">Informaci√≥n personal y de diagn√≥stico del cliente.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div id="anamnesis-display-container">
                             <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Ficha Personal</h3>
                                <button id="edit-anamnesis-btn" class="text-sm bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-lg hover:bg-blue-200">Editar Ficha</button>
                            </div>
                            <div id="anamnesis-display" class="space-y-6">
                                <!-- Display content will be rendered by JS -->
                            </div>
                        </div>

                        <form id="anamnesis-form" class="hidden space-y-6">
                            <!-- Form content will be populated by JS -->
                            <div id="anamnesis-form-fields" class="space-y-6"></div>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button type="button" id="cancel-anamnesis-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </section>

                <section id="diary" class="hidden space-y-6">
                         <div class="text-center">
                             <h2 class="text-3xl font-bold text-gray-900">Diario Hol√≠stico</h2>
                             <p class="mt-2 text-gray-600">Registra tus h√°bitos diarios y descubre su impacto en tu piel.</p>
                         </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4">Registro del D√≠a - Hoy</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 text-center">
                            <div data-item="sue√±o" class="diary-item p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                <span class="text-3xl">üò¥</span><p class="text-sm mt-1">Sue√±o</p>
                            </div>
                             <div data-item="agua" class="diary-item p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                <span class="text-3xl">üíß</span><p class="text-sm mt-1">Agua</p>
                            </div>
                             <div data-item="estres" class="diary-item p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                <span class="text-3xl">üßò</span><p class="text-sm mt-1">Estr√©s</p>
                            </div>
                             <div data-item="dieta" class="diary-item p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                <span class="text-3xl">üçî</span><p class="text-sm mt-1">Dieta</p>
                            </div>
                             <div data-item="ejercicio" class="diary-item p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                <span class="text-3xl">üèÉ‚Äç‚ôÄÔ∏è</span><p class="text-sm mt-1">Ejercicio</p>
                            </div>
                             <div data-item="ciclo" class="diary-item p-3 bg-gray-100 rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                <span class="text-3xl">üîÑ</span><p class="text-sm mt-1">Ciclo</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4">Correlaciones Inteligentes</h3>
                        <div id="correlations-output" class="space-y-3">
                            <p class="text-gray-500">Registra tus h√°bitos y escaneos durante varios d√≠as para empezar a ver patrones.</p>
                        </div>
                    </div>
                </section>

                <section id="shelf" class="hidden space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-900">Mi Estanter√≠a Virtual</h2>
                        <p class="mt-2 text-gray-600">Gestiona tus productos y obt√©n an√°lisis de sus ingredientes.</p>
                    </div>
                    <div class="flex justify-end">
                        <button id="add-product-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">A√±adir Producto</button>
                    </div>
                    <div id="shelf-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 items-start">
                        <p id="shelf-empty-msg" class="text-gray-500 col-span-full text-center">Tu estanter√≠a est√° vac√≠a. ¬°A√±ade tu primer producto!</p>
                    </div>
                </section>

                <section id="routines" class="hidden space-y-6">
                         <div class="text-center">
                             <h2 class="text-3xl font-bold text-gray-900">Generador de Rutinas Inteligentes</h2>
                             <p class="mt-2 text-gray-600">Rutinas AM y PM personalizadas basadas en tu piel y tus productos.</p>
                         </div>
                         <div id="routine-loader" class="text-center hidden">
                             <div class="loader mx-auto"></div>
                             <p class="mt-4 text-gray-600">Generando rutina personalizada con IA...</p>
                         </div>
                    <div id="routine-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-2xl font-semibold mb-4 text-center">üåû Rutina de Ma√±ana (AM)</h3>
                            <div id="routine-am"></div>
                        </div>
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-2xl font-semibold mb-4 text-center">üåú Rutina de Noche (PM)</h3>
                            <div id="routine-pm"></div>
                        </div>
                    </div>
                    <div id="routine-advice-container" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hidden">
                        <h3 class="text-xl font-semibold mb-4 text-blue-800">Consejos Adicionales</h3>
                        <div id="routine-advice"></div>
                   </div>
                </section>

                <section id="progress" class="hidden space-y-6">
                         <div class="text-center">
                             <h2 class="text-3xl font-bold text-gray-900">Seguimiento de Progreso</h2>
                             <p class="mt-2 text-gray-600">Visualiza la evoluci√≥n de tu piel a lo largo del tiempo.</p>
                         </div>
                    <div id="progress-content">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-xl font-semibold mb-4 text-center">Evoluci√≥n de la Puntuaci√≥n Global</h3>
                             <div class="chart-container h-96">
                                <canvas id="progressChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mt-6">
                            <h3 class="text-xl font-semibold mb-4 text-center">Comparador Visual: Antes y Despu√©s</h3>
                            <div class="max-w-xl mx-auto">
                                <div class="image-compare-container">
                                    <img id="before-image" src="https://placehold.co/600x400/FFEBEB/DC2626?text=Primer+An%C3%A1lisis" alt="Foto anterior de la piel" class="w-full h-auto object-cover">
                                    <img id="after-image" src="https://placehold.co/600x400/EBF5FF/3B82F6?text=%C3%9Altimo+An%C3%A1lisis" alt="Foto actual de la piel" class="image-compare-after">
                                    <div class="image-compare-slider"></div>
                                </div>
                                <input type="range" min="0" max="100" value="50" class="w-full mt-2 cursor-ew-resize" id="compare-slider">
                            </div>
                        </div>
                    </div>
                    <div id="progress-empty" class="text-center text-gray-500 bg-white p-8 rounded-xl shadow-sm border border-gray-200 hidden">
                        <p>A√∫n no tienes ning√∫n an√°lisis guardado.</p>
                        <p>Ve a la secci√≥n "Esc√°ner Facial" para realizar tu primer an√°lisis y comenzar a seguir tu progreso.</p>
                    </div>
                </section>
                
                 <section id="treatments" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <div>
                             <h2 class="text-3xl font-bold text-gray-900">Historial y Pr√≥ximos Turnos</h2>
                             <p class="mt-2 text-gray-600">Consulta los tratamientos realizados y los turnos agendados para este cliente.</p>
                        </div>
                        <button id="add-treatment-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Agendar Turno</button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-xl font-semibold mb-4 text-green-700">Pr√≥ximos Turnos</h3>
                        <div id="upcoming-appointments-list" class="space-y-3 max-h-[30vh] overflow-y-auto">
                            <!-- Upcoming appointments will be dynamically inserted here -->
                        </div>
                    </div>

                     <div id="treatments-list-container" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                           <h3 class="text-xl font-semibold mb-4 text-blue-700">Historial de Turnos</h3>
                           <div id="treatments-list" class="space-y-4 max-h-[60vh] overflow-y-auto">
                                 <!-- Treatments will be dynamically inserted here -->
                           </div>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add Client Modal -->
    <div id="client-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-2xl font-bold mb-4">A√±adir Nuevo Cliente</h3>
            <form id="client-form">
                <div class="space-y-4">
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                        <input type="text" id="client-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="client-email" class="block text-sm font-medium text-gray-700">Email (Opcional)</label>
                        <input type="email" id="client-email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-client-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Service Modal -->
    <div id="service-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 id="service-modal-title" class="text-2xl font-bold mb-4">A√±adir Nuevo Servicio</h3>
            <form id="service-form">
                <input type="hidden" id="service-id">
                <div class="space-y-4">
                    <div>
                        <label for="service-name" class="block text-sm font-medium text-gray-700">Nombre del Servicio</label>
                        <input type="text" id="service-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="service-duration" class="block text-sm font-medium text-gray-700">Duraci√≥n (minutos)</label>
                        <input type="number" id="service-duration" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="service-price" class="block text-sm font-medium text-gray-700">Precio ($)</label>
                        <input type="number" id="service-price" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-service-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Servicio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Product Modal -->
    <div id="admin-product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 id="admin-product-modal-title" class="text-2xl font-bold mb-4">A√±adir Nuevo Producto</h3>
            <form id="admin-product-form">
                <input type="hidden" id="admin-product-id">
                <div class="space-y-4">
                    <div>
                        <label for="admin-product-name" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                        <input type="text" id="admin-product-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="admin-product-brand" class="block text-sm font-medium text-gray-700">Marca</label>
                        <input type="text" id="admin-product-brand" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="admin-product-stock" class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" id="admin-product-stock" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="admin-product-price" class="block text-sm font-medium text-gray-700">Precio de Venta ($)</label>
                        <input type="number" id="admin-product-price" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-admin-product-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Caja Modal -->
    <div id="caja-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 id="caja-modal-title" class="text-2xl font-bold mb-4">A√±adir Movimiento</h3>
            <form id="caja-form">
                <input type="hidden" id="caja-entry-type">
                <div class="space-y-4">
                    <div id="caja-origin-container" class="hidden">
                        <label for="caja-origin-type" class="block text-sm font-medium text-gray-700">Origen del Ingreso</label>
                        <select id="caja-origin-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="general">General</option>
                            <option value="servicio">Venta de Servicio</option>
                            <option value="producto">Venta de Producto</option>
                        </select>
                    </div>
                    <div id="caja-description-container">
                        <label for="caja-description" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="caja-description" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="caja-service-container" class="hidden">
                        <label for="caja-service-select" class="block text-sm font-medium text-gray-700">Seleccionar Servicio</label>
                        <select id="caja-service-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div id="caja-product-container" class="hidden">
                        <label for="caja-product-select" class="block text-sm font-medium text-gray-700">Seleccionar Producto</label>
                        <select id="caja-product-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div id="caja-discount-container" class="hidden">
                        <label for="caja-discount" class="block text-sm font-medium text-gray-700">Descuento</label>
                        <div class="mt-1 flex items-center">
                            <input type="number" id="caja-discount" step="0.01" placeholder="0.00" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 rounded-r-none">
                            <div class="flex">
                                <button type="button" id="discount-type-amount" class="discount-toggle-btn active">$</button>
                                <button type="button" id="discount-type-percent" class="discount-toggle-btn">%</button>
                            </div>
                        </div>
                        <p id="caja-price-summary" class="text-xs text-gray-500 mt-1"></p>
                    </div>
                    <div>
                        <label for="caja-amount" class="block text-sm font-medium text-gray-700">Monto Final ($)</label>
                        <input type="number" id="caja-amount" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="caja-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="caja-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-caja-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Appointment Modal -->
    <div id="appointment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 id="appointment-modal-title" class="text-2xl font-bold mb-4">Nuevo Turno</h3>
            <form id="appointment-form">
                <input type="hidden" id="appointment-id">
                <div class="space-y-4">
                    <div>
                        <label for="appointment-client" class="block text-sm font-medium text-gray-700">Cliente</label>
                        <select id="appointment-client" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                     <div>
                        <label for="appointment-service" class="block text-sm font-medium text-gray-700">Servicio</label>
                        <select id="appointment-service" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="appointment-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="appointment-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="appointment-time" class="block text-sm font-medium text-gray-700">Hora</label>
                            <input type="time" id="appointment-time" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="appointment-notes" class="block text-sm font-medium text-gray-700">Notas (Opcional)</label>
                        <textarea id="appointment-notes" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div id="new-appointment-se√±a-container" class="hidden">
                        <label for="appointment-se√±a" class="block text-sm font-medium text-gray-700">Monto Se√±a (Opcional)</label>
                        <input type="number" id="appointment-se√±a" step="0.01" placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                     <div id="se√±a-info" class="text-sm text-gray-600 hidden"></div>
                </div>
                <div class="mt-6 flex justify-between items-center">
                     <div class="flex space-x-2">
                           <button type="button" id="add-se√±a-btn" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 hidden">A√±adir Se√±a</button>
                           <button type="button" id="delete-appointment-btn" class="bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 hidden">Eliminar</button>
                     </div>
                    <div class="flex space-x-3 items-center">
                        <button type="button" id="complete-appointment-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 hidden">Marcar Cobrado</button>
                        <button type="button" id="cancel-appointment-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Turno</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <!-- Add Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-2xl font-bold mb-4">A√±adir Nuevo Producto</h3>
            <form id="product-form">
                <div class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700">Nombre del Producto</label>
                        <input type="text" id="product-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="product-brand" class="block text-sm font-medium text-gray-700">Marca</label>
                        <input type="text" id="product-brand" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="product-actives" class="block text-sm font-medium text-gray-700">Activos Principales (ej. Vitamina C, Retinol)</label>
                        <input type="text" id="product-actives" placeholder="Separados por comas" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-product-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Diary Entry Modal -->
    <div id="diary-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 id="diary-modal-title" class="text-2xl font-bold mb-4">Registrar H√°bito</h3>
            <form id="diary-form">
                <div id="diary-modal-content" class="space-y-4">
                    <!-- Dynamic content will be injected here -->
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-diary-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-black flex flex-col items-center justify-center p-4 hidden z-50">
        <div class="relative w-full max-w-lg aspect-square">
            <video id="camera-feed" class="w-full h-full object-cover rounded-lg" autoplay playsinline></video>
            <div id="camera-overlay"></div>
            <p class="absolute top-4 left-1/2 -translate-x-1/2 text-white text-center font-semibold bg-black bg-opacity-50 px-3 py-1 rounded-lg">Centre su rostro en el √≥valo</p>
        </div>
        <div class="mt-4 flex space-x-4">
            <button id="capture-btn" class="bg-white text-blue-600 font-semibold py-3 px-6 rounded-full hover:bg-gray-200 transition-colors">Tomar Foto</button>
            <button id="cancel-camera-btn" class="bg-red-500 text-white font-semibold py-3 px-6 rounded-full hover:bg-red-600 transition-colors">Cancelar</button>
        </div>
        <canvas id="photo-canvas" class="hidden"></canvas>
    </div>

    <!-- Product Analysis Modal -->
    <div id="product-analysis-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-40">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold">An√°lisis de Producto</h3>
                <button id="close-analysis-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="product-analysis-content" class="mt-4 space-y-3">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center">
            <h3 id="confirmation-title" class="text-2xl font-bold mb-2">¬øEst√°s seguro?</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-confirmation-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
     <!-- Add Se√±a Modal -->
    <div id="se√±a-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-2xl font-bold mb-4">A√±adir Se√±a</h3>
            <form id="se√±a-form">
                <div class="space-y-4">
                    <div>
                        <label for="se√±a-amount" class="block text-sm font-medium text-gray-700">Monto de la Se√±a ($)</label>
                        <input type="number" id="se√±a-amount" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancel-se√±a-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600">Guardar Se√±a</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, query, getDocs, writeBatch, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', () => {
            
            const appState = {
                currentUser: null,
                selectedClient: null,
                currentView: 'dashboard',
                listeners: {
                    global: {
                        clients: null,
                        services: null,
                        caja: null,
                        appointments: null,
                        adminProducts: null,
                    },
                    client: {
                        diary: null,
                        shelf: null,
                        progress: null,
                        anamnesis: null,
                    }
                },
                data: {
                    allScans: [],
                    allDiaryEntries: [],
                    allProducts: [],
                    lastScan: null,
                    clients: [],
                    services: [],
                    adminProducts: [],
                    cajaEntries: [],
                    appointments: [],
                    currentAgendaDate: new Date(),
                    currentBalanceDate: new Date(),
                    anamnesisData: null,
                },
                ui: {
                    skinMetricsChart: null,
                    progressChart: null,
                    monthlyBalanceChart: null,
                },
                temp: {
                    currentAppointment: null,
                    currentScanResults: null,
                    currentScanId: null,
                    cameraStream: null,
                    editingServiceId: null,
                    editingAdminProductId: null,
                    routineUpdateTimeout: null
                }
            };
            
            // --- DOM Element Declarations ---
            const authStatus = document.getElementById('auth-status');
            const addClientBtn = document.getElementById('add-client-btn');
            const clientModal = document.getElementById('client-modal');
            const clientForm = document.getElementById('client-form');
            const cancelClientBtn = document.getElementById('cancel-client-btn');
            const selectedClientName = document.getElementById('selected-client-name');
            const clientSearchInput = document.getElementById('client-search-input');
            const addServiceBtn = document.getElementById('add-service-btn');
            const serviceModal = document.getElementById('service-modal');
            const serviceModalTitle = document.getElementById('service-modal-title');
            const serviceForm = document.getElementById('service-form');
            const cancelServiceBtn = document.getElementById('cancel-service-btn');
            const servicesList = document.getElementById('services-list');
            const cameraModal = document.getElementById('camera-modal');
            const activateCameraBtn = document.getElementById('activate-camera-btn');
            const cancelCameraBtn = document.getElementById('cancel-camera-btn');
            const captureBtn = document.getElementById('capture-btn');
            const cameraFeed = document.getElementById('camera-feed');
            const photoCanvas = document.getElementById('photo-canvas');
            const userPhoto = document.getElementById('user-photo');
            const heatmapToggle = document.getElementById('heatmap-toggle');
            const heatmapOverlay = document.getElementById('heatmap-overlay');
            const uploadPhotoBtn = document.getElementById('upload-photo-btn');
            const photoUploadInput = document.getElementById('photo-upload-input');
            const cameraErrorMsg = document.getElementById('api-error-msg');
            const initialActions = document.getElementById('initial-actions');
            const afterPhotoActions = document.getElementById('after-photo-actions');
            const resetPhotoBtn = document.getElementById('reset-photo-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const diaryItems = document.querySelectorAll('.diary-item');
            const diaryModal = document.getElementById('diary-modal');
            const diaryModalTitle = document.getElementById('diary-modal-title');
            const diaryModalContent = document.getElementById('diary-modal-content');
            const diaryForm = document.getElementById('diary-form');
            const cancelDiaryBtn = document.getElementById('cancel-diary-btn');
            const productModal = document.getElementById('product-modal');
            const addProductBtn = document.getElementById('add-product-btn');
            const cancelProductBtn = document.getElementById('cancel-product-btn');
            const productForm = document.getElementById('product-form');
            const shelfGrid = document.getElementById('shelf-grid');
            const progressContent = document.getElementById('progress-content');
            const progressEmpty = document.getElementById('progress-empty');
            const beforeImage = document.getElementById('before-image');
            const afterImage = document.getElementById('after-image');
            const compareSlider = document.getElementById('compare-slider');
            const sliderLine = document.querySelector('.image-compare-slider');
            const emailResultsBtn = document.getElementById('email-results-btn');
            const correlationsOutput = document.getElementById('correlations-output');
            const productAnalysisModal = document.getElementById('product-analysis-modal');
            const productAnalysisContent = document.getElementById('product-analysis-content');
            const closeAnalysisModalBtn = document.getElementById('close-analysis-modal-btn');
            const addTreatmentBtn = document.getElementById('add-treatment-btn');
            const treatmentsList = document.getElementById('treatments-list');
            const clientProfileContainer = document.getElementById('client-profile-container');
            const appNavLinks = document.querySelectorAll('.app-nav-link');
            const clientNavLinks = document.querySelectorAll('#client-nav .nav-link');
            const adminMenuToggle = document.getElementById('admin-menu-toggle');
            const adminSubmenu = document.getElementById('admin-submenu');

            // Admin Products DOM Elements
            const addAdminProductBtn = document.getElementById('add-admin-product-btn');
            const adminProductModal = document.getElementById('admin-product-modal');
            const adminProductModalTitle = document.getElementById('admin-product-modal-title');
            const adminProductForm = document.getElementById('admin-product-form');
            const cancelAdminProductBtn = document.getElementById('cancel-admin-product-btn');
            const adminProductsList = document.getElementById('admin-products-list');

            // Anamnesis DOM Elements
            const anamnesisDisplayContainer = document.getElementById('anamnesis-display-container');
            const anamnesisDisplay = document.getElementById('anamnesis-display');
            const anamnesisForm = document.getElementById('anamnesis-form');
            const editAnamnesisBtn = document.getElementById('edit-anamnesis-btn');


            // Caja DOM Elements
            const addIngresoBtn = document.getElementById('add-ingreso-btn');
            const addGastoBtn = document.getElementById('add-gasto-btn');
            const cajaModal = document.getElementById('caja-modal');
            const cajaModalTitle = document.getElementById('caja-modal-title');
            const cajaForm = document.getElementById('caja-form');
            const cancelCajaBtn = document.getElementById('cancel-caja-btn');

            // Agenda DOM Elements
            const agendaView = document.getElementById('agenda-view');
            const agendaDateRange = document.getElementById('agenda-date-range');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');
            const todayBtn = document.getElementById('today-btn');
            const appointmentModal = document.getElementById('appointment-modal');
            const appointmentModalTitle = document.getElementById('appointment-modal-title');
            const appointmentForm = document.getElementById('appointment-form');
            const cancelAppointmentBtn = document.getElementById('cancel-appointment-btn');
            const deleteAppointmentBtn = document.getElementById('delete-appointment-btn');
            const completeAppointmentBtn = document.getElementById('complete-appointment-btn');
            const addSe√±aBtn = document.getElementById('add-se√±a-btn');
            const se√±aInfo = document.getElementById('se√±a-info');
            const newAppointmentSe√±aContainer = document.getElementById('new-appointment-se√±a-container');


            // Se√±a Modal DOM Elements
            const se√±aModal = document.getElementById('se√±a-modal');
            const se√±aForm = document.getElementById('se√±a-form');
            const cancelSe√±aBtn = document.getElementById('cancel-se√±a-btn');

            // Balance Mensual DOM Elements
            const balanceMonthDisplay = document.getElementById('balance-month-display');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');

            // Discount Toggle Buttons
            const discountTypeAmountBtn = document.getElementById('discount-type-amount');
            const discountTypePercentBtn = document.getElementById('discount-type-percent');

            // Dashboard DOM Elements
            const dashboardAddAppointmentBtn = document.getElementById('dashboard-add-appointment-btn');
            const dashboardAddClientBtn = document.getElementById('dashboard-add-client-btn');
            const dashboardGoToCajaBtn = document.getElementById('dashboard-go-to-caja-btn');


            // --- Generic Confirmation Modal Elements & Logic ---
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationTitle = document.getElementById('confirmation-title');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
            let confirmCallback = null;

            function showConfirmationModal(title, message, onConfirm) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmationModal.classList.remove('hidden');
            }

            confirmActionBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                confirmationModal.classList.add('hidden');
                confirmCallback = null;
            });

            cancelConfirmationBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                confirmCallback = null;
            });


            // --- Function Definitions ---
            function showView(view) {
                appState.currentView = view;
                document.getElementById('dashboard').classList.toggle('hidden', view !== 'dashboard');
                document.getElementById('clients').classList.toggle('hidden', view !== 'clients');
                document.getElementById('agenda').classList.toggle('hidden', view !== 'agenda');
                document.getElementById('servicios').classList.toggle('hidden', view !== 'servicios');
                document.getElementById('productos').classList.toggle('hidden', view !== 'productos');
                document.getElementById('caja').classList.toggle('hidden', view !== 'caja');
                document.getElementById('balance-mensual').classList.toggle('hidden', view !== 'balance-mensual');
                clientProfileContainer.classList.toggle('hidden', view !== 'profile');
                
                appNavLinks.forEach(l => l.classList.remove('active'));
                document.querySelectorAll('#admin-submenu .nav-link').forEach(l => l.classList.remove('active'));


                if (['servicios', 'caja', 'balance-mensual', 'productos'].includes(view)) {
                    adminMenuToggle.classList.add('active');
                    adminSubmenu.classList.remove('hidden');
                    const activeSublink = document.querySelector(`#admin-submenu a[href="#${view}"]`);
                    if(activeSublink) activeSublink.classList.add('active');
                } else {
                    if(!adminSubmenu.classList.contains('hidden')) adminSubmenu.classList.add('hidden');
                    const activeLinkSelector = view === 'profile' ? '#clients' : `#${view}`;
                    const activeLink = document.querySelector(`#app-nav > a[href="${activeLinkSelector}"], #app-nav > div[href="${activeLinkSelector}"]`);
                    if (activeLink && activeLink.id !== 'admin-menu-toggle') activeLink.classList.add('active');
                }

                document.getElementById('client-context-nav').classList.toggle('hidden', view !== 'profile');
                
                if(view === 'dashboard') {
                    renderDashboard();
                }
                if (view === 'agenda') {
                    renderAgenda();
                }
                if (view === 'balance-mensual') {
                    renderMonthlyBalance();
                }
            }

            function showSection(targetId) {
                document.querySelectorAll('#client-profile-container section').forEach(section => {
                    section.classList.toggle('hidden', section.id !== targetId);
                });
                clientNavLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === `#${targetId}`);
                });
            }

            function handleNavigation(hash) {
                const targetId = hash ? hash.substring(1) : 'dashboard';
                
                if (['dashboard', 'clients', 'agenda', 'servicios', 'caja', 'balance-mensual', 'productos'].includes(targetId)) {
                     if (appState.selectedClient) {
                           deselectClient();
                     }
                    showView(targetId);
                } else if (appState.selectedClient) {
                    showView('profile');
                    showSection(targetId);
                     if (targetId === 'routines') {
                           debouncedUpdateRoutines();
                     }
                } else {
                    window.location.hash = '#dashboard';
                    showView('dashboard');
                }
            }
            
            // --- ANAMNESIS FUNCTIONS ---
            const anamnesisFields = [
                { section: "Motivo de Consulta", fields: [
                    { id: 'motivoConsulta', label: 'Motivo de la consulta', type: 'textarea' },
                ]},
                { section: "Antecedentes de Salud", fields: [
                    { id: 'alergias', label: 'Alergias (medicamentos, cosm√©ticos, alimentos)', type: 'text' },
                    { id: 'enfermedades', label: 'Enfermedades (diabetes, hipertensi√≥n, tiroides, c√°ncer, etc.)', type: 'text' },
                    { id: 'medicacion', label: 'Medicaci√≥n actual (incluye anticonceptivos)', type: 'text' },
                    { id: 'implantes', label: 'Implantes met√°licos, marcapasos, DIU', type: 'text' },
                    { id: 'embarazo', label: 'Embarazo o lactancia', type: 'select', options: ['No', 'S√≠', 'Posibilidad'] },
                ]},
                { section: "H√°bitos y Cuidado de la Piel", fields: [
                    { id: 'rutinaActual', label: 'Rutina de cuidado facial actual (productos y frecuencia)', type: 'textarea' },
                    { id: 'usoProtectorSolar', label: 'Uso de protector solar (frecuencia, SPF)', type: 'text' },
                    { id: 'exposicionSolar', label: 'Exposici√≥n solar (trabajo, hobbies)', type: 'text' },
                    { id: 'dieta', label: 'Tipo de dieta', type: 'text' },
                    { id: 'ingestaAgua', label: 'Ingesta de agua diaria (en vasos)', type: 'number' },
                    { id: 'sueno', label: 'Calidad del sue√±o (horas promedio)', type: 'number' },
                    { id: 'tabaquismo', label: 'Tabaquismo', type: 'select', options: ['No', 'Ocasional', 'Habitual'] },
                    { id: 'estres', label: 'Nivel de estr√©s habitual', type: 'select', options: ['Bajo', 'Medio', 'Alto'] },
                ]},
                { section: "Examen F√≠sico (Diagn√≥stico Profesional)", fields: [
                    { id: 'biotipoCutaneo', label: 'Biotipo cut√°neo', type: 'select', options: ['Eud√©rmica', 'Grasa', 'Seca', 'Mixta'] },
                    { id: 'fototipoCutaneo', label: 'Fototipo cut√°neo (Fitzpatrick)', type: 'select', options: ['I', 'II', 'III', 'IV', 'V', 'VI'] },
                    { id: 'estadoPiel', label: 'Estado de la piel', type: 'select', options: ['Normal', 'Deshidratada', 'Sensible', 'Asf√≠ctica'] },
                    { id: 'lesiones', label: 'Lesiones (m√°culas, p√°pulas, p√∫stulas, comedones, etc.)', type: 'textarea' },
                    { id: 'observacionesProfesional', label: 'Otras observaciones del profesional', type: 'textarea' },
                ]}
            ];

            function renderAnamnesisDisplay(data = {}) {
                anamnesisDisplay.innerHTML = '';
                anamnesisFields.forEach(section => {
                    const sectionEl = document.createElement('div');
                    sectionEl.innerHTML = `<h4 class="anamnesis-section-title">${section.section}</h4>`;
                    const gridEl = document.createElement('div');
                    gridEl.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                    
                    section.fields.forEach(field => {
                        const fieldEl = document.createElement('div');
                        fieldEl.innerHTML = `
                            <p class="ficha-label">${field.label}</p>
                            <p class="ficha-value">${data[field.id] || 'No especificado'}</p>
                        `;
                        gridEl.appendChild(fieldEl);
                    });
                    sectionEl.appendChild(gridEl);
                    anamnesisDisplay.appendChild(sectionEl);
                });
                anamnesisForm.classList.add('hidden');
                anamnesisDisplayContainer.classList.remove('hidden');
            }

            function renderAnamnesisForm(data = {}) {
                const formFieldsContainer = document.getElementById('anamnesis-form-fields');
                formFieldsContainer.innerHTML = '';
                 anamnesisFields.forEach(section => {
                    const sectionEl = document.createElement('div');
                    sectionEl.innerHTML = `<h4 class="anamnesis-section-title">${section.section}</h4>`;
                    const gridEl = document.createElement('div');
                    gridEl.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

                    section.fields.forEach(field => {
                        const fieldContainer = document.createElement('div');
                        let inputHTML = '';
                        const value = data[field.id] || '';
                        switch(field.type) {
                            case 'textarea':
                                inputHTML = `<textarea id="form-${field.id}" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">${value}</textarea>`;
                                break;
                            case 'select':
                                inputHTML = `<select id="form-${field.id}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                                    ${field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>`;
                                break;
                            default: // text, number
                                inputHTML = `<input type="${field.type}" id="form-${field.id}" value="${value}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">`;
                        }
                        fieldContainer.innerHTML = `<label for="form-${field.id}" class="block text-sm font-medium text-gray-700">${field.label}</label>${inputHTML}`;
                        gridEl.appendChild(fieldContainer);
                    });
                    sectionEl.appendChild(gridEl);
                    formFieldsContainer.appendChild(sectionEl);
                });
                
                anamnesisDisplayContainer.classList.add('hidden');
                anamnesisForm.classList.remove('hidden');
            }


            // --- DASHBOARD FUNCTIONS ---
            function renderDashboard() {
                const today = getTodayDateString();
                
                // Today's appointments
                const appointmentsListEl = document.getElementById('dashboard-appointments-list');
                const todayAppointments = appState.data.appointments
                    .filter(a => a.date === today)
                    .sort((a,b) => a.time.localeCompare(b.time));

                appointmentsListEl.innerHTML = '';
                if(todayAppointments.length === 0) {
                    appointmentsListEl.innerHTML = '<p class="text-gray-500 text-center">No hay turnos para hoy.</p>';
                } else {
                    todayAppointments.forEach(app => {
                        const client = appState.data.clients.find(c => c.id === app.clientId);
                        const service = appState.data.services.find(s => s.id === app.serviceId);
                        const appEl = document.createElement('div');
                        const isCompletedDashboard = app.status === 'completed';
                        appEl.className = `flex justify-between items-center p-3 rounded-lg border-l-4 ${isCompletedDashboard ? 'bg-green-50 border-green-500' : 'bg-blue-50 border-blue-500'}`;
                        appEl.innerHTML = `
                            <div>
                                <p class="font-bold text-lg">${app.time}</p>
                                <p class="font-semibold">${client ? client.name : 'Cliente no encontrado'}</p>
                                <p class="text-sm text-gray-600">${service ? service.name : 'Servicio no encontrado'}</p>
                            </div>
                            ${isCompletedDashboard ? '<span class="text-green-600 font-bold">Cobrado ‚úîÔ∏è</span>' : ''}
                        `;
                        appointmentsListEl.appendChild(appEl);
                    });
                }
                
                // Today's Caja summary
                const todayTransactions = appState.data.cajaEntries.filter(entry => entry.date === today);
                let ingresos = 0;
                let gastos = 0;
                todayTransactions.forEach(entry => {
                    if(entry.type === 'ingreso') {
                        ingresos += parseFloat(entry.amount);
                    } else {
                        gastos += parseFloat(entry.amount);
                    }
                });

                document.getElementById('dashboard-ingresos').textContent = `$${ingresos.toFixed(2)}`;
                document.getElementById('dashboard-gastos').textContent = `$${gastos.toFixed(2)}`;
                const balance = ingresos - gastos;
                const balanceEl = document.getElementById('dashboard-balance');
                balanceEl.textContent = `$${balance.toFixed(2)}`;
                balanceEl.classList.toggle('text-red-700', balance < 0);
                balanceEl.classList.toggle('text-blue-700', balance >= 0);
            }


            // --- BALANCE MENSUAL FUNCTIONS ---
            function renderMonthlyBalance() {
                const date = appState.data.currentBalanceDate;
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11
                const locale = 'es-ES';
                
                balanceMonthDisplay.textContent = date.toLocaleDateString(locale, { month: 'long', year: 'numeric' });

                const monthlyTransactions = appState.data.cajaEntries.filter(entry => {
                    const entryDate = new Date(entry.date + 'T00:00:00'); // Ensure correct date parsing
                    return entryDate.getFullYear() === year && entryDate.getMonth() === month;
                });
                
                let totalIngresos = 0;
                let totalGastos = 0;
                const dailyData = {};

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    dailyData[i] = { ingresos: 0, gastos: 0 };
                }

                monthlyTransactions.forEach(entry => {
                    const amount = parseFloat(entry.amount);
                    const day = new Date(entry.date + 'T00:00:00').getDate();
                    if (entry.type === 'ingreso') {
                        totalIngresos += amount;
                        if(dailyData[day]) dailyData[day].ingresos += amount;
                    } else {
                        totalGastos += amount;
                        if(dailyData[day]) dailyData[day].gastos += amount;
                    }
                });

                document.getElementById('monthly-ingresos').textContent = `$${totalIngresos.toFixed(2)}`;
                document.getElementById('monthly-gastos').textContent = `$${totalGastos.toFixed(2)}`;
                const balance = totalIngresos - totalGastos;
                const balanceEl = document.getElementById('monthly-balance');
                balanceEl.textContent = `$${balance.toFixed(2)}`;
                balanceEl.classList.toggle('text-red-700', balance < 0);
                balanceEl.classList.toggle('text-blue-700', balance >= 0);

                // Update Chart
                if (appState.ui.monthlyBalanceChart) {
                    appState.ui.monthlyBalanceChart.destroy();
                }
                const ctx = document.getElementById('monthlyBalanceChart').getContext('2d');
                const labels = Object.keys(dailyData);
                appState.ui.monthlyBalanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.map(day => `${day}`),
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: Object.values(dailyData).map(d => d.ingresos),
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Gastos',
                                data: Object.values(dailyData).map(d => d.gastos),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
                
                // Update transaction list
                const listEl = document.getElementById('monthly-transactions-list');
                listEl.innerHTML = '';
                if(monthlyTransactions.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center">No hay movimientos en este mes.</p>';
                    return;
                }
                monthlyTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                    const itemEl = document.createElement('div');
                    const amount = parseFloat(entry.amount);
                    const isIngreso = entry.type === 'ingreso';
                    itemEl.className = 'grid grid-cols-3 gap-4 items-center text-sm border-b py-2';
                    itemEl.innerHTML = `
                        <span class="text-gray-500">${formatDate(entry.date)}</span>
                        <span>${entry.description}</span>
                        <span class="font-semibold text-right ${isIngreso ? 'text-green-600' : 'text-red-600'}">
                            ${isIngreso ? '+' : '-'}$${amount.toFixed(2)}
                        </span>
                    `;
                    listEl.appendChild(itemEl);
                });
            }

            // --- AGENDA FUNCTIONS ---
            function renderAgenda() {
                const currentDate = appState.data.currentAgendaDate;
                const weekStart = new Date(currentDate);
                weekStart.setDate(currentDate.getDate() - (currentDate.getDay() + 6) % 7); // Monday as start of week
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                const locale = 'es-ES';
                agendaDateRange.textContent = `${weekStart.toLocaleDateString(locale, {day:'2-digit', month:'short'})} - ${weekEnd.toLocaleDateString(locale, {day:'2-digit', month:'short', year:'numeric'})}`;

                agendaView.innerHTML = '';
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(weekStart);
                    day.setDate(weekStart.getDate() + i);
                    
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'flex flex-col gap-2 p-1 rounded-lg bg-gray-100 border';
                    dayColumn.dataset.date = day.toISOString().split('T')[0];

                    const header = document.createElement('div');
                    const isToday = day.toDateString() === new Date().toDateString();
                    header.className = `agenda-day-header p-2 rounded-md text-center font-semibold text-sm ${isToday ? 'today' : 'bg-gray-200'}`;
                    header.textContent = `${day.toLocaleDateString(locale, {weekday:'short'}).toUpperCase()} ${day.getDate()}`;
                    
                    const appointmentsContainer = document.createElement('div');
                    appointmentsContainer.className = 'space-y-1 overflow-y-auto flex-1';
                    
                    const dayAppointments = appState.data.appointments
                        .filter(a => a.date === day.toISOString().split('T')[0])
                        .sort((a,b) => a.time.localeCompare(b.time));

                    dayAppointments.forEach(app => {
                        const client = appState.data.clients.find(c => c.id === app.clientId);
                        const service = appState.data.services.find(s => s.id === app.serviceId);
                        const isCompleted = app.status === 'completed';
                        const hasSe√±a = app.se√±a > 0;

                        const appCard = document.createElement('div');
                        appCard.className = `appointment-card p-2 rounded text-xs border-l-4 ${isCompleted ? 'bg-green-100 border-green-500' : 'bg-blue-100 border-blue-500'}`;
                        appCard.innerHTML = `
                             <div class="flex justify-between items-center">
                                 <p class="font-bold ${isCompleted ? 'text-green-800' : 'text-blue-800'}">${app.time}</p>
                                 <div class="flex items-center space-x-1">
                                     ${hasSe√±a && !isCompleted ? '<span>ü™ô</span>' : ''}
                                     ${isCompleted ? '<span>‚úîÔ∏è</span>' : ''}
                                 </div>
                             </div>
                            <p class="font-semibold">${client ? client.name : 'Cliente no encontrado'}</p>
                            <p class="text-gray-600 truncate">${service ? service.name : 'Servicio no encontrado'}</p>
                        `;
                        appCard.addEventListener('click', () => openAppointmentModal(app));
                        appointmentsContainer.appendChild(appCard);
                    });

                    const addBtn = document.createElement('button');
                    addBtn.className = "mt-auto text-center text-blue-600 hover:bg-blue-100 rounded-md p-1.5 text-xs font-semibold w-full transition-colors";
                    addBtn.textContent = '+ A√±adir Turno';
                    addBtn.addEventListener('click', () => openAppointmentModal(null, day.toISOString().split('T')[0]));


                    dayColumn.appendChild(header);
                    dayColumn.appendChild(appointmentsContainer);
                    dayColumn.appendChild(addBtn);
                    agendaView.appendChild(dayColumn);
                }
            }

            function openAppointmentModal(appointment = null, date = null, clientId = null) {
                appState.temp.currentAppointment = appointment;
                appointmentForm.reset();
                deleteAppointmentBtn.classList.add('hidden');
                completeAppointmentBtn.classList.add('hidden');
                addSe√±aBtn.classList.add('hidden');
                se√±aInfo.classList.add('hidden');
                newAppointmentSe√±aContainer.classList.add('hidden');

                const saveBtn = appointmentForm.querySelector('button[type="submit"]');
                saveBtn.disabled = false;

                // Populate clients
                const clientSelect = document.getElementById('appointment-client');
                clientSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' + appState.data.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                 if (clientId) {
                       clientSelect.value = clientId;
                 }
                
                // Populate services
                const serviceSelect = document.getElementById('appointment-service');
                serviceSelect.innerHTML = '<option value="">Seleccionar servicio...</option>' + appState.data.services.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

                if (appointment) {
                    appointmentModalTitle.textContent = 'Editar Turno';
                    document.getElementById('appointment-id').value = appointment.id;
                    clientSelect.value = appointment.clientId;
                    serviceSelect.value = appointment.serviceId;
                    document.getElementById('appointment-date').value = appointment.date;
                    document.getElementById('appointment-time').value = appointment.time;
                    document.getElementById('appointment-notes').value = appointment.notes || '';
                    deleteAppointmentBtn.classList.remove('hidden');

                    if (appointment.status === 'completed') {
                        completeAppointmentBtn.classList.add('hidden');
                        addSe√±aBtn.classList.add('hidden');
                        saveBtn.disabled = true;
                    } else {
                        completeAppointmentBtn.classList.remove('hidden');
                        addSe√±aBtn.classList.remove('hidden');
                        saveBtn.disabled = false;
                    }
                    
                    if (appointment.se√±a > 0) {
                        se√±aInfo.textContent = `Se√±a pagada: $${appointment.se√±a.toFixed(2)}`;
                        se√±aInfo.classList.remove('hidden');
                        addSe√±aBtn.classList.add('hidden'); 
                    }

                } else {
                    appointmentModalTitle.textContent = 'Nuevo Turno';
                    document.getElementById('appointment-id').value = '';
                    document.getElementById('appointment-date').value = date || new Date().toISOString().split('T')[0];
                    newAppointmentSe√±aContainer.classList.remove('hidden');
                    document.getElementById('appointment-se√±a').value = '';
                }

                appointmentModal.classList.remove('hidden');
            }

            async function startCamera() {
                cameraErrorMsg.classList.add('hidden');
                try {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        appState.temp.cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                        cameraFeed.srcObject = appState.temp.cameraStream;
                        cameraModal.classList.remove('hidden');
                    } else {
                        console.error('getUserMedia not supported on this browser!');
                        cameraErrorMsg.textContent = "Tu navegador no soporta el acceso a la c√°mara.";
                        cameraErrorMsg.classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('Error accessing camera: ', err);
                    cameraErrorMsg.textContent = "No se pudo acceder a la c√°mara. Revisa los permisos.";
                    cameraErrorMsg.classList.remove('hidden');
                }
            }

            function stopCamera() {
                if (appState.temp.cameraStream) {
                    appState.temp.cameraStream.getTracks().forEach(track => track.stop());
                }
                cameraModal.classList.add('hidden');
            }
            
            function showInitialActions() {
                initialActions.classList.remove('hidden');
                afterPhotoActions.classList.add('hidden');
                userPhoto.src = 'https://placehold.co/400x400/EBF5FF/3B82F6?text=Tu+Foto+Aqu%C3%AD';
                document.getElementById('results-container').classList.add('hidden');
                heatmapToggle.disabled = true;
                heatmapToggle.checked = false;
                heatmapOverlay.classList.add('opacity-0');
            }

            function showAfterPhotoActions() {
                initialActions.classList.add('hidden');
                afterPhotoActions.classList.remove('hidden');
            }

            async function callGeminiAPI(payload, model = 'gemini-2.5-flash-preview-05-20') {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                let retries = 3;
                let delay = 1000;

                for (let i = 0; i < retries; i++) {
                     const response = await fetch(apiUrl, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });

                     if (response.ok) {
                         return response.json();
                     }

                     // Do not retry on client errors (4xx) like auth errors.
                     if (response.status >= 400 && response.status < 500) {
                         throw new Error(`API Error: ${response.status}`);
                     }
                    
                     // Retry on server errors (5xx) or throttling.
                     if (i < retries - 1) {
                         await new Promise(resolve => setTimeout(resolve, delay));
                         delay *= 2;
                     } else {
                         throw new Error(`API Error after multiple retries: ${response.status}`);
                     }
                }
            }

            async function runAnalysis() {
                if (!appState.currentUser || !appState.selectedClient) return;

                const loaderContainer = document.getElementById('loader-container');
                const resultsContainer = document.getElementById('results-container');
                const analyzeBtnEl = document.getElementById('analyze-btn');
                
                loaderContainer.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                heatmapToggle.disabled = true;
                heatmapToggle.checked = false;
                analyzeBtnEl.disabled = true;
                analyzeBtnEl.textContent = 'Analizando...';
                cameraErrorMsg.classList.add('hidden');

                try {
                    const photoDataUrl = userPhoto.src;
                    const base64ImageData = photoDataUrl.split(',')[1];
                    
                    const prompt = "Act√∫a como un dermat√≥logo experto en an√°lisis de piel. Analiza la imagen facial proporcionada y devuelve un an√°lisis detallado en formato JSON. Las m√©tricas a analizar son: Hidrataci√≥n, Poros, L√≠neas Finas, Hiperpigmentaci√≥n, Acn√©, Rojeces, Textura y Luminosidad. Para cada m√©trica, proporciona una puntuaci√≥n de 0 a 100 y una descripci√≥n breve y profesional en espa√±ol con consejos para el cliente. Adem√°s, proporciona una puntuaci√≥n global y una edad aparente de la piel. Aseg√∫rate de que tu respuesta sea √∫nicamente el objeto JSON.";

                    const payload = {
                        contents: [
                            {
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "globalScore": { "type": "NUMBER" },
                                    "skinAge": { "type": "NUMBER" },
                                    "metrics": {
                                        "type": "ARRAY",
                                        "items": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "name": { "type": "STRING" },
                                                "score": { "type": "NUMBER" },
                                                "description": { "type": "STRING" }
                                            },
                                            required: ["name", "score", "description"]
                                        }
                                    }
                                },
                                required: ["globalScore", "skinAge", "metrics"]
                            }
                        }
                    };
                    
                    const result = await callGeminiAPI(payload);
                    
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Respuesta inv√°lida de la API de Gemini.");
                    }
                    
                    const analysisResult = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    const formattedResult = {
                        score: analysisResult.globalScore,
                        age: analysisResult.skinAge,
                        metrics: analysisResult.metrics
                    };
                    
                    appState.temp.currentScanResults = formattedResult;
                    appState.data.lastScan = formattedResult;
                    
                    const scansCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/scans`);
                    const docRef = await addDoc(scansCollectionRef, {
                        imageDataUrl: photoDataUrl,
                        globalScore: formattedResult.score,
                        skinAge: formattedResult.age,
                        metrics: formattedResult.metrics,
                        createdAt: new Date(),
                    });
                    appState.temp.currentScanId = docRef.id;
                    
                    populateScannerResults(formattedResult);
                    resultsContainer.classList.remove('hidden');
                    heatmapToggle.disabled = false;


                } catch (error) {
                    console.error("Error durante el an√°lisis facial:", error);
                    cameraErrorMsg.textContent = "No se pudo completar el an√°lisis. Int√©ntalo de nuevo m√°s tarde.";
                    cameraErrorMsg.classList.remove('hidden');
                } finally {
                    loaderContainer.classList.add('hidden');
                    analyzeBtnEl.disabled = false;
                    analyzeBtnEl.textContent = 'Iniciar An√°lisis Facial';
                }
            }
            
            function generateAndSendEmail() {
                if (!appState.temp.currentScanResults) {
                    alert('Primero debes completar un an√°lisis.');
                    return;
                }
                const { score, age, metrics } = appState.temp.currentScanResults;
                const subject = `Resultados de tu An√°lisis Facial - ${appState.selectedClient.name}`;
                let body = `¬°Hola ${appState.selectedClient.name}!\n\nAqu√≠ est√°n los resultados de tu √∫ltimo an√°lisis de piel con Ame Scan Facial:\n\n`;
                body += `------------------------------------\n`;
                body += `PUNTUACI√ìN GLOBAL: ${score}\n`;
                body += `EDAD APARENTE DE LA PIEL: ${age} a√±os\n`;
                body += `------------------------------------\n\n`;
                body += `AN√ÅLISIS DETALLADO Y CONSEJOS:\n\n`;
                metrics.forEach(metric => {
                    body += `üîµ ${metric.name.toUpperCase()}: ${metric.score}/100\n`;
                    body += `   Consejo: ${metric.description}\n\n`;
                });
                body += `\nGenerado por Ame Scan Facial.\n`;
                const mailtoLink = `mailto:${appState.selectedClient.email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            }

            function getTodayDateString() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }
            
            function formatDate(date) {
                if (!date) return '';
                const d = date instanceof Date ? date : new Date(date);
                 if (isNaN(d)) return '';
                return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }

            async function openDiaryModal(itemName, currentData) {
                diaryForm.dataset.item = itemName;
                let contentHTML = '';
                const currentValue = currentData[itemName] || '';
                
                const itemsConfig = {
                    sue√±o: { title: 'Horas de Sue√±o', type: 'number', placeholder: 'Ej. 8' },
                    agua: { title: 'Vasos de Agua', type: 'number', placeholder: 'Ej. 6' },
                    estres: { title: 'Nivel de Estr√©s (1-5)', type: 'range', min: 1, max: 5, step: 1 },
                    dieta: { title: 'Calidad de la Dieta', type: 'select', options: ['Mala', 'Regular', 'Buena', 'Excelente'] },
                    ejercicio: { title: '¬øHiciste ejercicio?', type: 'select', options: ['No', 'S√≠, ligero', 'S√≠, moderado', 'S√≠, intenso'] },
                    ciclo: { title: 'Fase del Ciclo Menstrual', type: 'select', options: ['Menstrual', 'Folicular', 'Ovulatoria', 'L√∫tea', 'No aplica'] },
                };

                const config = itemsConfig[itemName];
                diaryModalTitle.textContent = `Registrar ${config.title}`;
                
                if (config.type === 'number') {
                    contentHTML = `
                        <label for="diary-value" class="block text-sm font-medium text-gray-700">${config.title}</label>
                        <input type="number" id="diary-value" value="${currentValue}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="${config.placeholder}">
                    `;
                } else if (config.type === 'range') {
                     contentHTML = `
                        <label for="diary-value" class="block text-sm font-medium text-gray-700">${config.title}: <span id="range-value">${currentValue || 3}</span></label>
                        <input type="range" id="diary-value" value="${currentValue || 3}" min="${config.min}" max="${config.max}" step="${config.step}" class="w-full mt-2" oninput="document.getElementById('range-value').textContent = this.value">
                    `;
                } else if (config.type === 'select') {
                    contentHTML = `
                        <label for="diary-value" class="block text-sm font-medium text-gray-700">${config.title}</label>
                        <select id="diary-value" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            ${config.options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    `;
                }

                diaryModalContent.innerHTML = contentHTML;
                diaryModal.classList.remove('hidden');
            }

            async function saveDiaryValue(itemName, value) {
                if (!appState.currentUser || !appState.selectedClient) return;
                const today = getTodayDateString();
                const docRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/diaryEntries`, today);
                try {
                    await setDoc(docRef, { [itemName]: value, date: today }, { merge: true });
                    diaryModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error al guardar en el diario:", error);
                }
            }

            async function handleDiaryClick(e) {
                if (!appState.currentUser || !appState.selectedClient) return;
                const itemName = e.currentTarget.dataset.item;
                const today = getTodayDateString();
                const docRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/diaryEntries`, today);
                const docSnap = await getDoc(docRef);
                const currentData = docSnap.exists() ? docSnap.data() : {};
                openDiaryModal(itemName, currentData);
            }

            async function analyzeProductWithAI(product) {
                const contentEl = document.getElementById('product-analysis-content');
                contentEl.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-xl font-bold">${product.name}</h4>
                        <p class="text-md text-gray-500">${product.brand}</p>
                    </div>
                    <div id="product-analysis-loader" class="text-center">
                        <div class="loader mx-auto"></div>
                        <p class="mt-2 text-gray-600">Analizando ingredientes con IA...</p>
                    </div>
                    <div id="product-analysis-results" class="space-y-2 text-sm"></div>
                `;
                
                const loader = document.getElementById('product-analysis-loader');
                const resultsEl = document.getElementById('product-analysis-results');

                if (!appState.data.lastScan) {
                    resultsEl.innerHTML = `<p class="text-center text-gray-600">Por favor, realiza primero un escaneo facial para obtener un an√°lisis de producto personalizado.</p>`;
                    loader.classList.add('hidden');
                    return;
                }

                try {
                    const mainConcerns = appState.data.lastScan.metrics
                        .filter(m => m.score < 85)
                        .sort((a, b) => a.score - b.score)
                        .slice(0, 3)
                        .map(m => m.name)
                        .join(', ');

                    const prompt = `
                        Act√∫a como un experto qu√≠mico cosm√©tico. Analiza el siguiente producto para un cliente cuyas principales preocupaciones de la piel son: ${mainConcerns || 'piel normal'}.

                        **Producto:**
                        - **Nombre:** ${product.name}
                        - **Marca:** ${product.brand}
                        - **Ingredientes Activos Clave declarados:** ${product.actives}

                        **An√°lisis requerido:**
                        Proporciona un an√°lisis conciso y profesional en espa√±ol. El formato debe ser:
                        1.  **Idoneidad General:** Una frase que resuma si el producto es adecuado o no para el cliente.
                        2.  **An√°lisis de Activos:** Una lista de vi√±etas (usando '*' como vi√±eta). Para cada activo principal mencionado, crea un punto con el siguiente formato:
                            - **Nombre del Activo:** (en negrita) seguido de sus 2 o 3 beneficios clave m√°s importantes en una sola frase.

                        Ejemplo de un punto en la lista:
                        * **Vitamina C:** Antioxidante potente, ilumina la piel y ayuda a unificar el tono.

                        S√© directo, utiliza un lenguaje claro y educativo. No incluyas saludos, despedidas ni texto introductorio innecesario.
                    `.trim();

                    const payload = { 
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    const result = await callGeminiAPI(payload);
                    
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Respuesta inv√°lida de la API.");
                    }

                    const analysisText = result.candidates[0].content.parts[0].text;
                    
                    let htmlResult = analysisText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                        .replace(/^\s*\*\s*(.*$)/gm, '<li class="flex items-start"><span class="mr-2 mt-1">üîµ</span><span>$1</span></li>')
                        .replace(/\n/g, '<br>');

                    if (htmlResult.includes('<li')) {
                        const listItems = htmlResult.match(/<li.*<\/li>/g).join('');
                        const nonListItems = htmlResult.replace(/<li.*<\/li>/g, '').replace(/(<br>)+/g, '<br>');
                        htmlResult = nonListItems + '<ul>' + listItems + '</ul>';
                    }

                    resultsEl.innerHTML = htmlResult;

                } catch (error) {
                    console.error("Error al analizar el producto:", error);
                    resultsEl.innerHTML = `<p class="text-center text-red-500">No se pudo completar el an√°lisis en este momento. Int√©ntalo de nuevo m√°s tarde.</p>`;
                } finally {
                    loader.classList.add('hidden');
                }
            }
            
            function openProductAnalysisModal(product) {
                productAnalysisModal.classList.remove('hidden');
                analyzeProductWithAI(product);
            }
            
            function detachClientListeners() {
                Object.values(appState.listeners.client).forEach(unsubscribe => {
                    if (unsubscribe && typeof unsubscribe === 'function') {
                        unsubscribe();
                    }
                });
                Object.keys(appState.listeners.client).forEach(k => appState.listeners.client[k] = null);
            }

            function setupClientDataListeners() {
                if (!appState.currentUser || !appState.selectedClient) return;
                
                detachClientListeners();

                const diaryCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/diaryEntries`);
                    appState.listeners.client.diary = onSnapshot(diaryCollectionRef, (snapshot) => {
                        appState.data.allDiaryEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const todayData = appState.data.allDiaryEntries.find(e => e.id === getTodayDateString()) || {};
                        diaryItems.forEach(item => {
                            const itemName = item.dataset.item;
                            const hasData = todayData[itemName] != null && todayData[itemName] !== '';
                            item.classList.toggle('selected', hasData);
                        });
                        
                    });
                
                const scansCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/scans`);
                appState.listeners.client.progress = onSnapshot(query(scansCollectionRef), (snapshot) => {
                    let scans = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    scans.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                    appState.data.allScans = scans;
                    
                    if (scans.length === 0) {
                        progressContent.classList.add('hidden');
                        progressEmpty.classList.remove('hidden');
                        appState.data.lastScan = null;
                    } else {
                        progressContent.classList.remove('hidden');
                        progressEmpty.classList.add('hidden');
                        appState.data.lastScan = scans[scans.length - 1];
                        updateProgressChart(scans);
                        updateBeforeAfterComparator(scans);
                    }
                    
                    // The routine update is now handled only when navigating to the routines tab to avoid multiple calls.
                });

                const shelfCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/products`);
                appState.listeners.client.shelf = onSnapshot(shelfCollectionRef, (querySnapshot) => {
                    const products = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.data.allProducts = products;
                    shelfGrid.innerHTML = '';
                    if (products.length === 0) {
                        shelfGrid.innerHTML = `<p id="shelf-empty-msg" class="text-gray-500 col-span-full text-center">Tu estanter√≠a est√° vac√≠a. ¬°A√±ade tu primer producto!</p>`;
                    } else {
                        products.forEach(product => {
                            const productJsonString = JSON.stringify(product).replace(/'/g, "&apos;");
                            const productCard = `
                                <div data-product-json='${productJsonString}' class="shelf-product-card bg-white p-5 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                                    <button data-id="${product.id}" class="delete-product-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1 z-10">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                    <h4 class="font-semibold text-lg pr-6">${product.name}</h4>
                                    <p class="text-sm text-gray-500">${product.brand}</p>
                                    <p class="text-xs text-gray-400 mt-2 truncate">Activos: ${product.actives || 'No especificados'}</p>
                                    <div class="p-3 bg-gray-50 border-l-4 border-blue-300 rounded-r-lg text-center mt-3">
                                         <p class="text-sm text-blue-600 font-medium">Haz clic para analizar</p>
                                    </div>
                                </div>
                            `;
                            shelfGrid.innerHTML += productCard;
                        });
                    }
                    // The routine update is now handled only when navigating to the routines tab to avoid multiple calls.

                    document.querySelectorAll('.delete-product-btn').forEach(button => {
                        button.addEventListener('click', (e) => { e.stopPropagation(); deleteProduct(e.currentTarget.dataset.id); });
                    });
                    document.querySelectorAll('.shelf-product-card').forEach(card => {
                        card.addEventListener('click', (e) => { openProductAnalysisModal(JSON.parse(e.currentTarget.dataset.productJson.replace(/&apos;/g, "'"))); });
                    });
                });

                const anamnesisDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/anamnesis/ficha`);
                appState.listeners.client.anamnesis = onSnapshot(anamnesisDocRef, (docSnap) => {
                    appState.data.anamnesisData = docSnap.exists() ? docSnap.data() : {};
                    renderAnamnesisDisplay(appState.data.anamnesisData);
                });
            }

            async function deleteProduct(productId) {
                if (!appState.currentUser || !appState.selectedClient || !productId) return;
                showConfirmationModal(
                    'Eliminar Producto',
                    '¬øEst√°s seguro de que quieres eliminar este producto de la estanter√≠a?',
                    async () => {
                         const docRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/products`, productId);
                         await deleteDoc(docRef).catch(err => console.error("Error al eliminar producto:", err));
                    }
                );
            }
            
            async function deleteClient(clientId) {
                if (!appState.currentUser || !clientId) return;
                const subcollections = ['scans', 'diaryEntries', 'products', 'treatments', 'appointments', 'anamnesis'];
                const batch = writeBatch(db);
                for (const sub of subcollections) {
                    const subCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${clientId}/${sub}`);
                    const snapshot = await getDocs(subCollectionRef);
                    snapshot.forEach(doc => batch.delete(doc.ref));
                }

                // Delete appointments where this client is the clientId
                const appointmentsQuery = query(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`), where("clientId", "==", clientId));
                const appointmentsSnapshot = await getDocs(appointmentsQuery);
                appointmentsSnapshot.forEach(doc => batch.delete(doc.ref));

                const clientDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients`, clientId);
                batch.delete(clientDocRef);
                await batch.commit().catch(err => console.error("Error deleting client:", err));
            }
            
            // --- ROUTINE GENERATION LOGIC ---
            function debouncedUpdateRoutines() {
                clearTimeout(appState.temp.routineUpdateTimeout);
                appState.temp.routineUpdateTimeout = setTimeout(updateRoutines, 400);
            }
            async function updateRoutines() {
                const routineAmEl = document.getElementById('routine-am');
                const routinePmEl = document.getElementById('routine-pm');
                const routineAdviceContainer = document.getElementById('routine-advice-container');
                const routineAdviceEl = document.getElementById('routine-advice');
                const routineLoader = document.getElementById('routine-loader');
                const routineContent = document.getElementById('routine-content');
                
                const placeholder = '<p class="text-gray-500 text-center">Realiza un escaneo y a√±ade productos a tu estanter√≠a para generar una rutina personalizada.</p>';

                if (!appState.data.lastScan || !appState.data.allProducts) {
                    routineAmEl.innerHTML = placeholder;
                    routinePmEl.innerHTML = '';
                    routineAdviceContainer.classList.add('hidden');
                    return;
                }

                routineContent.classList.add('hidden');
                routineAdviceContainer.classList.add('hidden');
                routineLoader.classList.remove('hidden');

                try {
                    const mainConcerns = appState.data.lastScan.metrics
                        .filter(m => m.score < 85)
                        .sort((a, b) => a.score - b.score)
                        .slice(0, 3)
                        .map(m => m.name)
                        .join(', ');

                    const ownedProducts = appState.data.allProducts.map(p => `- ${p.name} (Activos: ${p.actives})`).join('\n');

                    const prompt = `
                        Act√∫a como un cosmet√≥logo experto y minimalista. Tu objetivo es crear una rutina de cuidado facial efectiva, breve y l√≥gica para un cliente, bas√°ndote **estrictamente** en los datos proporcionados.

                        **1. Diagn√≥stico del Cliente (basado en an√°lisis):**
                        Preocupaciones Principales: ${mainConcerns || 'Piel en buen estado general.'}

                        **2. Estanter√≠a del Cliente (productos que ya tiene):**
                        ${ownedProducts || 'El cliente no ha a√±adido productos a su estanter√≠a.'}

                        **Tu Tarea:**
                        Crea un objeto JSON con las claves "routineAM", "routinePM", y "generalAdvice". Sigue estas reglas de forma OBLIGATORIA:

                        - **Orden L√≥gico de la Rutina:** Las rutinas DEBEN seguir este orden de pasos: Limpieza > Contorno de Ojos > Tratamiento (S√©rum) > Hidrataci√≥n > Protecci√≥n Solar (solo AM). Omite un paso solo si no hay un producto adecuado en la estanter√≠a Y no es un paso esencial. NUNCA alteres el orden.

                        - **L√≥gica de Recomendaci√≥n de Productos:**
                            1. **Usar productos existentes:** Para cada paso, primero busca en la "Estanter√≠a del Cliente" UN producto adecuado. Prioriza el que mejor se alinee con las "Preocupaciones Principales". Si lo encuentras, √∫salo.
                            2. **Recomendar gen√©ricos para pasos b√°sicos:** Si para un paso esencial (Limpieza, Hidrataci√≥n, Protecci√≥n Solar) NO encuentras un producto en la estanter√≠a, recomienda el tipo de producto gen√©rico que el cliente necesita. Ejemplo: "Usa un limpiador suave para piel sensible."
                            3. **Identificar y recomendar productos faltantes (CR√çTICO):** Si para el paso "Tratamiento (S√©rum)" no hay un producto en la estanter√≠a que aborde las "Preocupaciones Principales", la recomendaci√≥n debe ser sugerir la compra de un producto con activos espec√≠ficos. Ejemplo: "Te recomendamos buscar un s√©rum con √Åcido Hialur√≥nico para mejorar la hidrataci√≥n."

                        - **Formato de Salida (JSON):**
                            - "routineAM": Un array de objetos, cada uno con "step" y "recommendation".
                            - "routinePM": Un array de objetos, cada uno con "step" y "recommendation".
                            - La clave "recommendation" DEBE incluir el nombre del producto (en negrita si es de la estanter√≠a y lo est√°s usando) y una instrucci√≥n de aplicaci√≥n MUY BREVE.
                            - "generalAdvice": Un array de 1 o 2 strings con consejos cortos y muy importantes que no encajen en la rutina, como recordatorios de constancia o sobre activos a evitar.

                        **IMPORTANTE:** No inventes nombres de productos. Usa solo los de la lista o recomienda un tipo gen√©rico como se ha explicado. Responde √∫nicamente con el objeto JSON.
                    `.trim();

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    routineAM: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                step: { type: "STRING" },
                                                recommendation: { type: "STRING" }
                                            },
                                            required: ["step", "recommendation"]
                                        }
                                    },
                                    routinePM: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                step: { type: "STRING" },
                                                recommendation: { type: "STRING" }
                                            },
                                            required: ["step", "recommendation"]
                                        }
                                    },
                                    generalAdvice: {
                                        type: "ARRAY",
                                        items: { type: "STRING" }
                                    }
                                },
                                required: ["routineAM", "routinePM", "generalAdvice"]
                            }
                        }
                    };

                    const result = await callGeminiAPI(payload);
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Respuesta inv√°lida de la API.");
                    }
                    
                    const routineData = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    const generateRoutineHTML = (routine) => {
                        if (!routine || routine.length === 0) return '<p class="text-gray-500">No se generaron recomendaciones para esta rutina.</p>';
                        return `<ul class="space-y-3">${routine.map(r => `<li class="text-sm"><strong>${r.step || ''}:</strong> ${(r.recommendation || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</li>`).join('')}</ul>`;
                    };

                    routineAmEl.innerHTML = generateRoutineHTML(routineData.routineAM);
                    routinePmEl.innerHTML = generateRoutineHTML(routineData.routinePM);

                    if (routineData.generalAdvice && routineData.generalAdvice.length > 0) {
                        routineAdviceEl.innerHTML = `<ul class="space-y-2 list-disc list-inside text-sm">${routineData.generalAdvice.map(a => `<li>${a}</li>`).join('')}</ul>`;
                        routineAdviceContainer.classList.remove('hidden');
                    }

                } catch(error) {
                    console.error("Error generando rutina con IA:", error);
                    const errorMsg = '<p class="text-red-500 text-center">No se pudo generar la rutina en este momento. Int√©ntalo de nuevo m√°s tarde.</p>';
                    routineAmEl.innerHTML = errorMsg;
                    routinePmEl.innerHTML = '';
                } finally {
                    routineLoader.classList.add('hidden');
                    routineContent.classList.remove('hidden');
                }
            }


            function updateProgressChart(scans) {
                if (appState.ui.progressChart) {
                    appState.ui.progressChart.destroy();
                }
                const ctx = document.getElementById('progressChart').getContext('2d');
                const labels = scans.map(s => formatDate(s.createdAt?.toDate()));
                const data = scans.map(s => s.globalScore);
                appState.ui.progressChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Puntuaci√≥n Global', data, borderColor: '#3b82f6', tension: 0.1, fill: false }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: false, max: 100 } } }
                });
            }
            
            function updateBeforeAfterComparator(scans) {
                if (scans.length > 0) {
                    beforeImage.src = scans[0].imageDataUrl;
                    if (scans.length === 1) {
                         beforeImage.src = 'https://placehold.co/600x400/FFEBEB/DC2626?text=Primer+An%C3%A1lisis';
                         afterImage.src = scans[0].imageDataUrl;
                    } else {
                         afterImage.src = scans[scans.length - 1].imageDataUrl;
                    }
                }
            }
            
            function renderPastAppointments() {
                const listEl = document.getElementById('treatments-list');
                if (!listEl) return;

                if (!appState.selectedClient) {
                    listEl.innerHTML = '';
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const pastAppointments = appState.data.appointments
                    .filter(app => {
                        const appDate = new Date(app.date + 'T00:00:00');
                        return app.clientId === appState.selectedClient.id && appDate < today;
                    })
                    .sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA > dateB) return -1; // Sort descending
                        if (dateA < dateB) return 1;
                        return b.time.localeCompare(a.time); // Also descending for time
                    });

                listEl.innerHTML = '';
                if (pastAppointments.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">No hay turnos pasados en el historial.</p>';
                    return;
                }

                pastAppointments.forEach(app => {
                    const service = appState.data.services.find(s => s.id === app.serviceId);
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-4 bg-blue-50 rounded-lg border border-blue-200';
                    itemEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                 <h4 class="font-semibold text-blue-800">${service ? service.name : 'Servicio no encontrado'}</h4>
                                 <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${app.notes || 'Sin notas adicionales.'}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <p class="font-bold">${formatDate(app.date)}</p>
                                <p class="text-sm text-gray-600">${app.time}</p>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(itemEl);
                });
            }


            function populateScannerResults(results) {
                 document.getElementById('global-score').textContent = results.score;
                 document.getElementById('skin-age').textContent = results.age;
                 document.getElementById('global-score-feedback').textContent = results.score > 80 ? '¬°Un resultado excelente! Sigue as√≠.' : 'Un buen resultado. ¬°Hay √°reas para mejorar!';

                const metricsDetails = document.getElementById('metrics-details');
                metricsDetails.innerHTML = '';
                results.metrics.forEach(metric => {
                    metricsDetails.innerHTML += `
                        <div class="p-3 border-l-4 rounded-r-lg ${metric.score > 80 ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'}">
                            <p class="font-semibold ${metric.score > 80 ? 'text-green-800' : 'text-yellow-800'}">${metric.name} - Puntuaci√≥n: ${metric.score}/100</p>
                            <p class="text-sm text-gray-600">${metric.description}</p>
                        </div>
                    `;
                });

                if (appState.ui.skinMetricsChart) appState.ui.skinMetricsChart.destroy();
                const ctx = document.getElementById('skinMetricsChart').getContext('2d');
                appState.ui.skinMetricsChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: results.metrics.map(m => m.name),
                        datasets: [{ label: 'Tu Piel', data: results.metrics.map(m => m.score), backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }]
                    },
                    options: { maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 100, pointLabels: { font: { size: 10 } } } } }
                });
            }

            function selectClient(client) {
                appState.selectedClient = client;
                selectedClientName.textContent = client.name;
                setupClientDataListeners();
                renderUpcomingAppointments();
                renderPastAppointments();
                window.location.hash = '#scanner';
            }

            function deselectClient() {
                appState.selectedClient = null;
                detachClientListeners();
                renderUpcomingAppointments(); 
                renderPastAppointments();
                showInitialActions(); 
                document.getElementById('shelf-grid').innerHTML = '';
                document.getElementById('routine-am').innerHTML = '';
                document.getElementById('routine-pm').innerHTML = '';
                if(appState.ui.progressChart) { appState.ui.progressChart.destroy(); appState.ui.progressChart = null; }
                if(appState.ui.skinMetricsChart) { appState.ui.skinMetricsChart.destroy(); appState.ui.skinMetricsChart = null; }

            }

            function renderCaja(entries) {
                const ingresosList = document.getElementById('ingresos-list');
                const gastosList = document.getElementById('gastos-list');
                ingresosList.innerHTML = '';
                gastosList.innerHTML = '';

                let totalIngresos = 0;
                let totalGastos = 0;

                entries.forEach(entry => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'text-sm flex justify-between items-center border-b pb-1';
                    const amount = parseFloat(entry.amount) || 0;
                    
                    if (entry.type === 'ingreso') {
                        totalIngresos += amount;
                        itemEl.innerHTML = `<span>${entry.description} <span class="text-xs text-gray-400">${formatDate(entry.date)}</span></span> <span class="font-semibold text-green-600">+$${amount.toFixed(2)}</span>`;
                        ingresosList.prepend(itemEl);
                    } else {
                        totalGastos += amount;
                        itemEl.innerHTML = `<span>${entry.description} <span class="text-xs text-gray-400">${formatDate(entry.date)}</span></span> <span class="font-semibold text-red-600">-$${amount.toFixed(2)}</span>`;
                        gastosList.prepend(itemEl);
                    }
                });

                document.getElementById('total-ingresos').textContent = `$${totalIngresos.toFixed(2)}`;
                document.getElementById('total-gastos').textContent = `$${totalGastos.toFixed(2)}`;
                const balance = totalIngresos - totalGastos;
                const balanceEl = document.getElementById('balance');
                balanceEl.textContent = `$${balance.toFixed(2)}`;
                balanceEl.classList.toggle('text-red-700', balance < 0);
                balanceEl.classList.toggle('text-blue-700', balance >= 0);
            }
            
            function renderUpcomingAppointments() {
                const listEl = document.getElementById('upcoming-appointments-list');
                if (!listEl) return;

                if (!appState.selectedClient) {
                    listEl.innerHTML = '';
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const upcomingAppointments = appState.data.appointments
                    .filter(app => {
                        const appDate = new Date(app.date + 'T00:00:00');
                        return app.clientId === appState.selectedClient.id && appDate >= today;
                    })
                    .sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        if (dateA < dateB) return -1;
                        if (dateA > dateB) return 1;
                        return a.time.localeCompare(b.time);
                    });

                listEl.innerHTML = '';
                if (upcomingAppointments.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500">No hay turnos futuros agendados.</p>';
                    return;
                }

                upcomingAppointments.forEach(app => {
                    const service = appState.data.services.find(s => s.id === app.serviceId);
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 bg-green-50 rounded-lg border-l-4 border-green-500';
                    itemEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-green-800">${service ? service.name : 'Servicio no encontrado'}</h4>
                                <p class="text-sm text-gray-600">${app.notes || 'Sin notas adicionales.'}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <p class="font-bold">${formatDate(app.date)}</p>
                                <p class="text-sm text-gray-600">${app.time}</p>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(itemEl);
                });
            }

            // --- Event Listener Attachments ---
            window.addEventListener('hashchange', () => handleNavigation(window.location.hash));
            window.addEventListener('popstate', () => handleNavigation(window.location.hash));
            
            appNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.hash = e.currentTarget.getAttribute('href') || '#dashboard';
                });
            });

            clientNavLinks.forEach(link => {
                 link.addEventListener('click', (e) => {
                       e.preventDefault();
                       window.location.hash = e.currentTarget.getAttribute('href');
                 });
            });
            
            adminMenuToggle.addEventListener('click', () => {
                adminSubmenu.classList.toggle('hidden');
                if(!adminSubmenu.classList.contains('hidden')) {
                    if(!['servicios', 'caja', 'balance-mensual', 'productos'].includes(appState.currentView)) {
                         window.location.hash = '#servicios';
                    }
                }
            });

            // --- Initial Calls ---
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    appState.currentUser = user;
                    authStatus.textContent = `Profesional conectado`;
                    
                    // --- GLOBAL LISTENERS (NOT TIED TO A CLIENT) ---
                    if(appState.listeners.global.services) appState.listeners.global.services();
                    appState.listeners.global.services = onSnapshot(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/services`), (snapshot) => {
                         appState.data.services = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                         updateServicesList();
                    });

                    if(appState.listeners.global.adminProducts) appState.listeners.global.adminProducts();
                    appState.listeners.global.adminProducts = onSnapshot(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/adminProducts`), (snapshot) => {
                        appState.data.adminProducts = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        renderAdminProducts();
                    });

                    if(appState.listeners.global.caja) appState.listeners.global.caja();
                    appState.listeners.global.caja = onSnapshot(query(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/caja`)), (snapshot) => {
                         let entries = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                         entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                         appState.data.cajaEntries = entries;
                         renderCaja(entries);
                         if(appState.currentView === 'dashboard') renderDashboard();
                         if(appState.currentView === 'balance-mensual') renderMonthlyBalance();
                    });

                    if(appState.listeners.global.appointments) appState.listeners.global.appointments();
                    appState.listeners.global.appointments = onSnapshot(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`), (snapshot) => {
                         appState.data.appointments = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                         if(appState.currentView === 'agenda') renderAgenda();
                         if(appState.currentView === 'dashboard') renderDashboard();
                         if (appState.selectedClient) {
                              renderUpcomingAppointments();
                              renderPastAppointments();
                         }
                    });

                    if(appState.listeners.global.clients) appState.listeners.global.clients();
                    appState.listeners.global.clients = onSnapshot(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients`), (snapshot) => {
                        appState.data.clients = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        renderClients();
                        if(appState.currentView === 'dashboard') renderDashboard();
                    });
                    
                    handleNavigation(window.location.hash);
                } else {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                           await signInWithCustomToken(auth, __initial_auth_token);
                     } else {
                           await signInAnonymously(auth);
                     }
                }
            });

            function renderClients() {
                const filterText = clientSearchInput.value || '';
                const clientList = document.getElementById('client-list');
                clientList.innerHTML = '';
                
                const filteredClients = appState.data.clients.filter(client => client.name.toLowerCase().includes(filterText.toLowerCase()));

                if (filteredClients.length > 0) {
                    filteredClients.forEach(client => {
                        const clientCard = document.createElement('div');
                        clientCard.className = 'client-card bg-white p-4 rounded-lg shadow-sm border border-gray-200 relative';
                        clientCard.innerHTML = `
                            <button data-id="${client.id}" class="delete-client-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1 z-10">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <div class="cursor-pointer">
                                <h3 class="font-semibold text-lg text-blue-800 pr-6">${client.name}</h3>
                                <p class="text-sm text-gray-500">${client.email || 'Sin email'}</p>
                            </div>
                        `;
                        clientCard.querySelector('.cursor-pointer').addEventListener('click', () => selectClient(client));
                        clientCard.querySelector('.delete-client-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            showConfirmationModal(
                                'Eliminar Cliente',
                                'Esta acci√≥n eliminar√° al cliente y todo su historial de forma permanente. No se puede deshacer.',
                                async () => {
                                    await deleteClient(client.id);
                                    if (appState.selectedClient?.id === client.id) {
                                        window.location.hash = '#clients';
                                    }
                                }
                            );
                        });
                        clientList.appendChild(clientCard);
                    });
                } else {
                    clientList.innerHTML = '<p class="text-gray-500 col-span-full text-center">No se encontraron clientes.</p>';
                }
            };
            clientSearchInput.addEventListener('input', renderClients);
            
            function updateServicesList() {
                servicesList.innerHTML = '';
                if (appState.data.services.length === 0) {
                    servicesList.innerHTML = '<p class="text-gray-500">No hay servicios a√±adidos.</p>';
                    return;
                }
                appState.data.services.forEach(service => {
                    const serviceEl = document.createElement('div');
                    serviceEl.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    serviceEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${service.name}</p>
                            <p class="text-sm text-gray-600">${service.duration} min - $${parseFloat(service.price).toFixed(2)}</p>
                        </div>
                        <div class="space-x-2">
                            <button data-id="${service.id}" class="edit-service-btn text-blue-600 hover:text-blue-800">Editar</button>
                            <button data-id="${service.id}" class="delete-service-btn text-red-600 hover:text-red-800">Eliminar</button>
                        </div>
                    `;
                    servicesList.appendChild(serviceEl);
                });

                document.querySelectorAll('.edit-service-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const service = appState.data.services.find(s => s.id === e.target.dataset.id);
                    if (service) {
                        serviceModalTitle.textContent = 'Editar Servicio';
                        document.getElementById('service-id').value = service.id;
                        document.getElementById('service-name').value = service.name;
                        document.getElementById('service-duration').value = service.duration;
                        document.getElementById('service-price').value = service.price;
                        serviceModal.classList.remove('hidden');
                    }
                }));

                document.querySelectorAll('.delete-service-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const serviceIdToDelete = e.currentTarget.dataset.id;
                     showConfirmationModal(
                          'Eliminar Servicio',
                          '¬øEst√°s seguro de que quieres eliminar este servicio?',
                          async () => {
                                await deleteDoc(doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/services`, serviceIdToDelete));
                          }
                     );
                }));
            }

            function renderAdminProducts() {
                adminProductsList.innerHTML = '';
                if (appState.data.adminProducts.length === 0) {
                    adminProductsList.innerHTML = '<p class="text-gray-500">No hay productos en el inventario.</p>';
                    return;
                }
                appState.data.adminProducts.forEach(product => {
                    const productEl = document.createElement('div');
                    productEl.className = 'grid grid-cols-5 gap-2 items-center p-3 bg-gray-50 rounded-lg';
                    productEl.innerHTML = `
                        <div class="col-span-2">
                            <p class="font-semibold">${product.name}</p>
                            <p class="text-sm text-gray-600">${product.brand}</p>
                        </div>
                        <div class="text-center">
                            <p class="font-semibold text-gray-800">$${parseFloat(product.price || 0).toFixed(2)}</p>
                        </div>
                        <div class="text-center">
                            <span class="font-semibold px-3 py-1 rounded-full ${product.stock > 5 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${product.stock}</span>
                        </div>
                        <div class="text-right space-x-2">
                            <button data-id="${product.id}" class="edit-admin-product-btn text-blue-600 hover:text-blue-800">Editar</button>
                            <button data-id="${product.id}" class="delete-admin-product-btn text-red-600 hover:text-red-800">Eliminar</button>
                        </div>
                    `;
                    adminProductsList.appendChild(productEl);
                });

                document.querySelectorAll('.edit-admin-product-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const product = appState.data.adminProducts.find(p => p.id === e.target.dataset.id);
                    if (product) {
                        openAdminProductModal(product);
                    }
                }));

                document.querySelectorAll('.delete-admin-product-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const productIdToDelete = e.currentTarget.dataset.id;
                    showConfirmationModal(
                        'Eliminar Producto',
                        '¬øEst√°s seguro de que quieres eliminar este producto del inventario?',
                        async () => {
                            await deleteDoc(doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/adminProducts`, productIdToDelete));
                        }
                    );
                }));
            }

            // --- More Event Listeners ---
            addClientBtn.addEventListener('click', () => { clientForm.reset(); clientModal.classList.remove('hidden'); });
            cancelClientBtn.addEventListener('click', () => clientModal.classList.add('hidden'));
            clientForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;
                const newClient = {
                    name: document.getElementById('client-name').value,
                    email: document.getElementById('client-email').value,
                    createdAt: new Date(),
                };
                const collectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients`);
                await addDoc(collectionRef, newClient);
                clientModal.classList.add('hidden');
            });
            
            addServiceBtn.addEventListener('click', () => {
                serviceForm.reset();
                serviceModalTitle.textContent = 'A√±adir Nuevo Servicio';
                document.getElementById('service-id').value = '';
                serviceModal.classList.remove('hidden');
            });
            cancelServiceBtn.addEventListener('click', () => serviceModal.classList.add('hidden'));
            
            serviceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Guardando...';

                try {
                    const serviceId = document.getElementById('service-id').value;
                    const serviceData = {
                        name: document.getElementById('service-name').value,
                        duration: document.getElementById('service-duration').value,
                        price: document.getElementById('service-price').value,
                    };
                    if (serviceId) {
                        await setDoc(doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/services`, serviceId), serviceData, { merge: true });
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/services`), serviceData);
                    }
                    serviceModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving service:", error);
                    alert("Hubo un error al guardar el servicio. Por favor, int√©ntalo de nuevo.");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });

            function openAdminProductModal(product = null) {
                adminProductForm.reset();
                if (product) {
                    adminProductModalTitle.textContent = 'Editar Producto';
                    document.getElementById('admin-product-id').value = product.id;
                    document.getElementById('admin-product-name').value = product.name;
                    document.getElementById('admin-product-brand').value = product.brand;
                    document.getElementById('admin-product-stock').value = product.stock;
                    document.getElementById('admin-product-price').value = product.price || '';
                } else {
                    adminProductModalTitle.textContent = 'A√±adir Nuevo Producto';
                    document.getElementById('admin-product-id').value = '';
                }
                adminProductModal.classList.remove('hidden');
            }

            addAdminProductBtn.addEventListener('click', () => openAdminProductModal());
            cancelAdminProductBtn.addEventListener('click', () => adminProductModal.classList.add('hidden'));

            adminProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;

                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Guardando...';

                const productId = document.getElementById('admin-product-id').value;
                const productData = {
                    name: document.getElementById('admin-product-name').value,
                    brand: document.getElementById('admin-product-brand').value,
                    stock: parseInt(document.getElementById('admin-product-stock').value, 10),
                    price: parseFloat(document.getElementById('admin-product-price').value) || 0,
                };

                try {
                    if (productId) {
                        await setDoc(doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/adminProducts`, productId), productData, { merge: true });
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/adminProducts`), productData);
                    }
                    adminProductModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving admin product:", error);
                    alert("Hubo un error al guardar el producto.");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Guardar Producto';
                }
            });
            
            function openCajaModal(type) {
                cajaForm.reset();
                document.getElementById('caja-entry-type').value = type;
                document.getElementById('caja-date').value = new Date().toISOString().split('T')[0];
            
                const originContainer = document.getElementById('caja-origin-container');
                const descriptionContainer = document.getElementById('caja-description-container');
                const serviceContainer = document.getElementById('caja-service-container');
                const productContainer = document.getElementById('caja-product-container');
                const descriptionInput = document.getElementById('caja-description');
                const discountContainer = document.getElementById('caja-discount-container');
                const priceSummary = document.getElementById('caja-price-summary');
                
                serviceContainer.classList.add('hidden');
                productContainer.classList.add('hidden');
                discountContainer.classList.add('hidden');
                priceSummary.textContent = '';
            
                if (type === 'ingreso') {
                    cajaModalTitle.textContent = 'A√±adir Ingreso';
                    originContainer.classList.remove('hidden');
                    descriptionContainer.classList.remove('hidden');
                    descriptionInput.disabled = false;
            
                    const serviceSelect = document.getElementById('caja-service-select');
                    serviceSelect.innerHTML = '<option value="">Seleccionar un servicio...</option>' 
                        + appState.data.services.map(s => `<option value="${s.id}" data-price="${s.price}">${s.name}</option>`).join('');
            
                    const productSelect = document.getElementById('caja-product-select');
                    productSelect.innerHTML = '<option value="">Seleccionar un producto...</option>' 
                        + appState.data.adminProducts.filter(p => p.stock > 0).map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} (Stock: ${p.stock})</option>`).join('');
            
                } else {
                    cajaModalTitle.textContent = 'A√±adir Gasto';
                    originContainer.classList.add('hidden');
                    descriptionContainer.classList.remove('hidden');
                    descriptionInput.disabled = false;
                }

                discountTypeAmountBtn.classList.add('active');
                discountTypePercentBtn.classList.remove('active');
                
                document.getElementById('caja-origin-type').value = 'general';
                cajaModal.classList.remove('hidden');
            }
            
            addIngresoBtn.addEventListener('click', () => openCajaModal('ingreso'));
            addGastoBtn.addEventListener('click', () => openCajaModal('gasto'));
            cancelCajaBtn.addEventListener('click', () => cajaModal.classList.add('hidden'));

            function updateCajaAmount() {
                const originType = document.getElementById('caja-origin-type').value;
                const discountContainer = document.getElementById('caja-discount-container');
                const priceSummary = document.getElementById('caja-price-summary');
                const amountInput = document.getElementById('caja-amount');
                const discountInput = document.getElementById('caja-discount');
                const discountValue = parseFloat(discountInput.value) || 0;
                const isPercentDiscount = discountTypePercentBtn.classList.contains('active');

                let originalPrice = 0;

                if (originType === 'servicio') {
                    const serviceSelect = document.getElementById('caja-service-select');
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        originalPrice = parseFloat(selectedOption.dataset.price) || 0;
                    }
                } else if (originType === 'producto') {
                    const productSelect = document.getElementById('caja-product-select');
                    const selectedOption = productSelect.options[productSelect.selectedIndex];
                    if (selectedOption && selectedOption.value) {
                        originalPrice = parseFloat(selectedOption.dataset.price) || 0;
                    }
                }

                if (originType === 'servicio' || originType === 'producto') {
                    discountContainer.classList.remove('hidden');
                    let discountAmount = 0;
                    if (isPercentDiscount) {
                        discountAmount = originalPrice * (discountValue / 100);
                    } else {
                        discountAmount = discountValue;
                    }

                    const finalAmount = originalPrice - discountAmount;
                    amountInput.value = finalAmount > 0 ? finalAmount.toFixed(2) : '0.00';
                    priceSummary.textContent = `Original: $${originalPrice.toFixed(2)} - Descuento: $${discountAmount.toFixed(2)} ${isPercentDiscount ? `(${discountValue}%)` : ''}`;
                } else {
                    discountContainer.classList.add('hidden');
                    priceSummary.textContent = '';
                }
            }
            
            const originTypeSelect = document.getElementById('caja-origin-type');
            const cajaServiceSelect = document.getElementById('caja-service-select');
            const cajaProductSelect = document.getElementById('caja-product-select');
            const cajaDiscountInput = document.getElementById('caja-discount');

            function handleCajaOriginChange() {
                const type = originTypeSelect.value;
                const descriptionContainer = document.getElementById('caja-description-container');
                const serviceContainer = document.getElementById('caja-service-container');
                const productContainer = document.getElementById('caja-product-container');
                const descriptionInput = document.getElementById('caja-description');
                const discountInput = document.getElementById('caja-discount');
                const amountInput = document.getElementById('caja-amount');
                
                descriptionContainer.classList.add('hidden');
                serviceContainer.classList.add('hidden');
                productContainer.classList.add('hidden');
                descriptionInput.disabled = true;
            
                if (type === 'general') {
                    descriptionContainer.classList.remove('hidden');
                    descriptionInput.disabled = false;
                    amountInput.value = '';
                } else if (type === 'servicio') {
                    serviceContainer.classList.remove('hidden');
                } else if (type === 'producto') {
                    productContainer.classList.remove('hidden');
                }
                
                discountInput.value = '';
                updateCajaAmount();
            }

            originTypeSelect.addEventListener('change', handleCajaOriginChange);
            cajaServiceSelect.addEventListener('change', updateCajaAmount);
            cajaProductSelect.addEventListener('change', updateCajaAmount);
            cajaDiscountInput.addEventListener('input', updateCajaAmount);

            cajaForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                if (!appState.currentUser) return;
            
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Guardando...';
            
                try {
                    const entryType = document.getElementById('caja-entry-type').value;
                    const originType = document.getElementById('caja-origin-type').value;

                    const newEntry = {
                        type: entryType,
                        amount: parseFloat(document.getElementById('caja-amount').value),
                        date: document.getElementById('caja-date').value,
                        createdAt: new Date(),
                    };

                    if (entryType === 'ingreso') {
                        newEntry.origin = originType;

                        const discountValue = parseFloat(document.getElementById('caja-discount').value) || 0;
                        const isPercentDiscount = discountTypePercentBtn.classList.contains('active');

                        if (discountValue > 0 && (originType === 'servicio' || originType === 'producto')) {
                            newEntry.discountValue = discountValue;
                            newEntry.discountType = isPercentDiscount ? 'percent' : 'amount';
                        }

                        if (originType === 'general') {
                            newEntry.description = document.getElementById('caja-description').value;
                        } else if (originType === 'servicio') {
                            const serviceId = document.getElementById('caja-service-select').value;
                            if (!serviceId) throw new Error("Servicio no seleccionado");
                            const service = appState.data.services.find(s => s.id === serviceId);
                            newEntry.description = `Venta Servicio: ${service.name}`;
                            newEntry.serviceId = serviceId;
                        } else if (originType === 'producto') {
                            const productId = document.getElementById('caja-product-select').value;
                            if (!productId) throw new Error("Producto no seleccionado");
                            const product = appState.data.adminProducts.find(p => p.id === productId);
                            newEntry.description = `Venta Producto: ${product.name}`;
                            newEntry.productId = productId;
                            
                            const newStock = product.stock - 1;
                            if (newStock < 0) throw new Error("Stock insuficiente");
                            const productDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/adminProducts`, productId);
                            await updateDoc(productDocRef, { stock: newStock });
                        }
                    } else { // Es un gasto
                        newEntry.description = document.getElementById('caja-description').value;
                    }
            
                    const collectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/caja`);
                    await addDoc(collectionRef, newEntry);
                    cajaModal.classList.add('hidden');
            
                } catch (error) {
                    console.error("Error saving cash entry:", error);
                    if (error.message !== "Servicio no seleccionado" && error.message !== "Producto no seleccionado" && error.message !== "Stock insuficiente") {
                        alert("Hubo un error al guardar el movimiento. Por favor, int√©ntalo de nuevo.");
                    } else {
                         alert(error.message); // Muestra el error espec√≠fico al usuario
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });


            editAnamnesisBtn.addEventListener('click', () => {
                renderAnamnesisForm(appState.data.anamnesisData);
            });

            anamnesisForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser || !appState.selectedClient) return;

                const submitBtn = anamnesisForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Guardando...';

                const updatedData = {};
                anamnesisFields.forEach(section => {
                    section.fields.forEach(field => {
                        const input = document.getElementById(`form-${field.id}`);
                        if(input) {
                            updatedData[field.id] = input.value;
                        }
                    });
                });
                
                try {
                    const anamnesisDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/anamnesis/ficha`);
                    await setDoc(anamnesisDocRef, updatedData, { merge: true });
                    renderAnamnesisDisplay(updatedData);
                } catch (error) {
                    console.error("Error al guardar la anamnesis: ", error);
                    alert("Hubo un error al guardar los cambios.");
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Guardar Cambios';
                }
            });

            anamnesisForm.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.id === 'cancel-anamnesis-btn') {
                     renderAnamnesisDisplay(appState.data.anamnesisData);
                }
            });

            activateCameraBtn.addEventListener('click', startCamera);
            cancelCameraBtn.addEventListener('click', stopCamera);
            captureBtn.addEventListener('click', () => {
                const context = photoCanvas.getContext('2d');
                const MAX_WIDTH = 600;
                const MAX_HEIGHT = 600;
                let width = cameraFeed.videoWidth;
                let height = cameraFeed.videoHeight;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                photoCanvas.width = width;
                photoCanvas.height = height;
                context.drawImage(cameraFeed, 0, 0, width, height);
                userPhoto.src = photoCanvas.toDataURL('image/jpeg', 0.9);
                stopCamera();
                showAfterPhotoActions();
            });

            uploadPhotoBtn.addEventListener('click', () => photoUploadInput.click());
            photoUploadInput.addEventListener('change', (event) => {
                if (event.target.files && event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = photoCanvas;
                            const context = canvas.getContext('2d');
                            const MAX_WIDTH = 600;
                            const MAX_HEIGHT = 600;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            context.drawImage(img, 0, 0, width, height);
                            userPhoto.src = canvas.toDataURL('image/jpeg', 0.9);
                            showAfterPhotoActions();
                        }
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(event.target.files[0]);
                }
            });

            resetPhotoBtn.addEventListener('click', showInitialActions);
            analyzeBtn.addEventListener('click', runAnalysis);
            heatmapToggle.addEventListener('change', () => heatmapOverlay.classList.toggle('opacity-0', !heatmapToggle.checked));
            diaryItems.forEach(item => item.addEventListener('click', handleDiaryClick));
            cancelDiaryBtn.addEventListener('click', () => diaryModal.classList.add('hidden'));
            addProductBtn.addEventListener('click', () => { productForm.reset(); productModal.classList.remove('hidden'); });
            cancelProductBtn.addEventListener('click', () => productModal.classList.add('hidden'));
            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser || !appState.selectedClient) return;
                const newProduct = {
                    name: document.getElementById('product-name').value,
                    brand: document.getElementById('product-brand').value,
                    actives: document.getElementById('product-actives').value,
                };
                await addDoc(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/clients/${appState.selectedClient.id}/products`), newProduct);
                productModal.classList.add('hidden');
            });

            compareSlider.addEventListener('input', (e) => {
                const value = e.target.value;
                afterImage.style.clipPath = `polygon(${value}% 0, 100% 0, 100% 100%, ${value}% 100%)`;
                sliderLine.style.left = `${value}%`;
            });
            emailResultsBtn.addEventListener('click', generateAndSendEmail);
            closeAnalysisModalBtn.addEventListener('click', () => productAnalysisModal.classList.add('hidden'));
            
            addTreatmentBtn.addEventListener('click', () => {
                openAppointmentModal(null, null, appState.selectedClient.id);
            });
            
            diaryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemName = e.target.dataset.item;
                const value = document.getElementById('diary-value').value;
                await saveDiaryValue(itemName, value);
            });

            // Agenda event listeners
            prevWeekBtn.addEventListener('click', () => {
                appState.data.currentAgendaDate.setDate(appState.data.currentAgendaDate.getDate() - 7);
                renderAgenda();
            });
            nextWeekBtn.addEventListener('click', () => {
                appState.data.currentAgendaDate.setDate(appState.data.currentAgendaDate.getDate() + 7);
                renderAgenda();
            });
            todayBtn.addEventListener('click', () => {
                appState.data.currentAgendaDate = new Date();
                renderAgenda();
            });
            cancelAppointmentBtn.addEventListener('click', () => appointmentModal.classList.add('hidden'));
            
            completeAppointmentBtn.addEventListener('click', async () => {
                const appointment = appState.temp.currentAppointment;
                if (!appointment || !appState.currentUser) return;

                if (appointment.status === 'completed') {
                    alert("Este turno ya fue marcado como cobrado.");
                    return;
                }

                const service = appState.data.services.find(s => s.id === appointment.serviceId);
                const client = appState.data.clients.find(c => c.id === appointment.clientId);

                if (service && client && service.price) {
                    const se√±aAmount = appointment.se√±a || 0;
                    const remainingAmount = parseFloat(service.price) - se√±aAmount;
                    const description = se√±aAmount > 0 ? `Saldo Servicio: ${service.name} (${client.name})` : `Servicio: ${service.name} (${client.name})`;

                    showConfirmationModal(
                        'Confirmar Cobro Final',
                        `Se a√±adir√° un ingreso de $${remainingAmount.toFixed(2)} a la caja. ¬øContinuar?`,
                        async () => {
                            try {
                                if (remainingAmount > 0) {
                                     const newIngreso = {
                                         type: 'ingreso',
                                         description: description,
                                         amount: remainingAmount,
                                         date: appointment.date,
                                         createdAt: new Date(),
                                         appointmentId: appointment.id
                                     };
                                     const cajaCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/caja`);
                                     await addDoc(cajaCollectionRef, newIngreso);
                                }

                                const appointmentDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`, appointment.id);
                                await updateDoc(appointmentDocRef, {
                                    status: 'completed'
                                });

                                appointmentModal.classList.add('hidden');

                            } catch (error) {
                                console.error("Error al completar el turno:", error);
                                alert("No se pudo completar la operaci√≥n. Int√©ntalo de nuevo.");
                            }
                        }
                    );
                } else {
                    alert("No se pudo encontrar la informaci√≥n del servicio o el precio para registrar el cobro.");
                }
            });
            
            appointmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!appState.currentUser) return;
                const appointmentId = document.getElementById('appointment-id').value;
                const appointmentData = {
                    clientId: document.getElementById('appointment-client').value,
                    serviceId: document.getElementById('appointment-service').value,
                    date: document.getElementById('appointment-date').value,
                    time: document.getElementById('appointment-time').value,
                    notes: document.getElementById('appointment-notes').value,
                    updatedAt: new Date(),
                };

                try {
                    if (appointmentId) {
                        const appointmentDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`, appointmentId);
                        await updateDoc(appointmentDocRef, appointmentData);
                    } else {
                        const se√±aAmount = parseFloat(document.getElementById('appointment-se√±a').value) || 0;
                        appointmentData.createdAt = new Date();
                        appointmentData.status = 'scheduled';
                        appointmentData.se√±a = se√±aAmount;
                        
                        const newAppointmentRef = await addDoc(collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`), appointmentData);
                        
                        if (se√±aAmount > 0) {
                            const service = appState.data.services.find(s => s.id === appointmentData.serviceId);
                            const client = appState.data.clients.find(c => c.id === appointmentData.clientId);

                            if (service && client) {
                                 const newIngreso = {
                                     type: 'ingreso',
                                     description: `Se√±a: ${service.name} (${client.name})`,
                                     amount: se√±aAmount,
                                     date: getTodayDateString(),
                                     createdAt: new Date(),
                                     appointmentId: newAppointmentRef.id
                                 };
                                 const cajaCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/caja`);
                                 await addDoc(cajaCollectionRef, newIngreso);
                            }
                        }
                    }
                    appointmentModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error saving appointment:", error);
                }
            });

            deleteAppointmentBtn.addEventListener('click', () => {
                 const appointmentId = document.getElementById('appointment-id').value;
                 if (appointmentId) {
                       showConfirmationModal(
                            'Eliminar Turno',
                            '¬øEst√°s seguro de que quieres eliminar este turno de la agenda?',
                            async () => {
                                 await deleteDoc(doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`, appointmentId));
                                 appointmentModal.classList.add('hidden');
                            }
                       );
                 }
            });

             addSe√±aBtn.addEventListener('click', () => {
                se√±aModal.classList.remove('hidden');
                se√±aForm.reset();
            });
            cancelSe√±aBtn.addEventListener('click', () => se√±aModal.classList.add('hidden'));
            se√±aForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const appointment = appState.temp.currentAppointment;
                if (!appointment || !appState.currentUser) return;

                const amount = parseFloat(document.getElementById('se√±a-amount').value);
                if (isNaN(amount) || amount <= 0) {
                    alert("Por favor, ingresa un monto v√°lido.");
                    return;
                }

                const service = appState.data.services.find(s => s.id === appointment.serviceId);
                const client = appState.data.clients.find(c => c.id === appointment.clientId);

                try {
                     const newIngreso = {
                         type: 'ingreso',
                         description: `Se√±a: ${service.name} (${client.name})`,
                         amount: amount,
                         date: getTodayDateString(),
                         createdAt: new Date(),
                         appointmentId: appointment.id
                     };
                     const cajaCollectionRef = collection(db, `artifacts/${appId}/users/${appState.currentUser.uid}/caja`);
                     await addDoc(cajaCollectionRef, newIngreso);

                    const appointmentDocRef = doc(db, `artifacts/${appId}/users/${appState.currentUser.uid}/appointments`, appointment.id);
                    await updateDoc(appointmentDocRef, {
                        se√±a: (appointment.se√±a || 0) + amount
                    });
                    se√±aModal.classList.add('hidden');
                    appointmentModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error al guardar la se√±a:", error);
                    alert("No se pudo guardar la se√±a. Int√©ntalo de nuevo.");
                }
            });
            
            discountTypeAmountBtn.addEventListener('click', () => {
                discountTypeAmountBtn.classList.add('active');
                discountTypePercentBtn.classList.remove('active');
                document.getElementById('caja-discount').value = ''; 
                updateCajaAmount();
            });

            discountTypePercentBtn.addEventListener('click', () => {
                discountTypePercentBtn.classList.add('active');
                discountTypeAmountBtn.classList.remove('active');
                document.getElementById('caja-discount').value = ''; 
                updateCajaAmount();
            });

            // Balance Mensual event listeners
            prevMonthBtn.addEventListener('click', () => {
                appState.data.currentBalanceDate.setMonth(appState.data.currentBalanceDate.getMonth() - 1);
                renderMonthlyBalance();
            });
            nextMonthBtn.addEventListener('click', () => {
                appState.data.currentBalanceDate.setMonth(appState.data.currentBalanceDate.getMonth() + 1);
                renderMonthlyBalance();
            });

            // Dashboard Quick Actions
            dashboardAddAppointmentBtn.addEventListener('click', () => {
                openAppointmentModal();
            });
            dashboardAddClientBtn.addEventListener('click', () => {
                clientForm.reset(); 
                clientModal.classList.remove('hidden');
            });
            dashboardGoToCajaBtn.addEventListener('click', () => {
                window.location.hash = '#caja';
            });


        });
    </script>
</body>
</html>

